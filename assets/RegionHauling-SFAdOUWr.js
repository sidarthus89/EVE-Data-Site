import{j as e}from"./index-CiZ_y1LZ.js";import{r as t,c as a}from"./react-vendor-qWGkjVPF.js";import{h as r,R as s,g as n,k as l,i,j as o,l as c,m as u}from"./common-0CtYHdO5.js";import{c as m}from"./market-CK_Tq7vn.js";const d=(e,t=2)=>{if(null==e||isNaN(e))return"0";return parseFloat(e).toLocaleString("en-US",{minimumFractionDigits:t,maximumFractionDigits:t})},p={fromRegion:null,toRegion:null,nearbyOnly:!1,minProfit:"500000",maxWeight:"",minROI:4,maxJumps:"",maxBudget:"",salesTax:7.5,securityStatus:"any",structureType:"all",routePreference:"safest",hideOutOfStock:!1};function h(){const[h,f]=t.useState(p),[y,g]=t.useState(null),[x,b]=t.useState(null),[v,j]=t.useState(!1),[N,P]=t.useState(0),[_,w]=t.useState([]),[S,I]=t.useState(null),[R,T]=t.useState(!1),[C,k]=t.useState([]),[D,M]=t.useState(1),[F]=t.useState(50),[J,B]=t.useState(!1),[O,$]=t.useState(!1),[L,E]=t.useState({key:"Net Profit",direction:"desc"}),[A,Q]=t.useState(!1),[W,U]=t.useState(null),[V,q]=t.useState(Date.now()),[z,X]=t.useState(null),[H,G]=t.useState(!1),K=a.useRef(new Set),[Y,Z]=t.useState({Item:140,From:240,Quantity:110,"Buy Price":130,"Total Buy Price":140,To:240,"Sell Price":140,"Net Profit":140,Jumps:90,"Profit per Jump":150,"Profit Per Item":130,ROI:100,"Total Capacity (m³)":120}),ee=({label:t})=>{const a=Y[t]||120;return e.jsxs("th",{onClick:()=>ue(t),style:{width:a,minWidth:a,maxWidth:a,position:"relative"},children:[t,L.key===t?"asc"===L.direction?" ▲":" ▼":"",e.jsx("span",{className:"col-resizer",onMouseDown:e=>{e.stopPropagation(),((e,t,a)=>{const r=r=>{const s=(r.clientX||0)-t;Z(t=>({...t,[e]:Math.max(60,Math.min(800,Math.round(a+s)))}))},s=()=>{window.removeEventListener("mousemove",r),window.removeEventListener("mouseup",s)};window.addEventListener("mousemove",r),window.addEventListener("mouseup",s)})(t,e.clientX||0,a)},title:"Drag to resize"})]})},te=e=>{const t=Y[e]||120;return{width:t,minWidth:t,maxWidth:t}},ae=(()=>{let e=null;return async t=>{try{if(!e){const t=await u();e=(e=>{const t=new Map,a=e=>{if(e&&"object"==typeof e){if(Array.isArray(e.items))for(const a of e.items){const e=Number(a.typeID);t.has(e)||t.set(e,{name:a.typeName,volume:a.volume||.01})}for(const t of Object.keys(e))"items"!==t&&"_info"!==t&&a(e[t])}};return a(e),t})(t)}const a=e.get(Number(t));return{volume:a?.volume||.01,name:a?.name||`Item ${t}`}}catch{return{volume:.01,name:`Item ${t}`}}}})(),re=a.useRef(new Map),se=a.useRef(new Map),ne=async(e,t)=>{const a=`${e}->${t}:${h.routePreference}`;if(re.current.has(a))return re.current.get(a);try{const r="safest"===h.routePreference?"secure":"shortest",s=await c(e,t,r);if(!s)return re.current.set(a,null),null;if("secure"===r){if(s.some(e=>{const t=se.current.get(e);return"number"==typeof t&&t<.5}))return re.current.set(a,null),null}const n=Math.max(0,s.length-1);return re.current.set(a,n),n}catch{return re.current.set(a,null),null}};t.useEffect(()=>{const e=()=>{const e=document.querySelector(".hauling-form");if(e){const t=e.getBoundingClientRect(),a=60;B(t.top<=a)}};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[]);const le=async e=>{try{await navigator.clipboard.writeText(e)}catch(t){}};t.useEffect(()=>{r().then(e=>{g(e)}).catch(e=>{I("Failed to load regions data")})},[]);const ie=t.useMemo(()=>y?y.map(e=>({regionID:e.region_id||e.regionID,regionName:e.region_name||e.regionName||e.name,...e})):[],[y]);t.useEffect(()=>{h.fromRegion&&ie.length,k([])},[h.fromRegion,ie]),t.useEffect(()=>{h.nearbyOnly&&C.length>0?f(e=>({...e,toRegion:{regionID:"nearby",regionName:`${C.length} Nearby Regions`}})):h.nearbyOnly||"nearby"!==h.toRegion?.regionID||f(e=>({...e,toRegion:null}))},[h.nearbyOnly,C]);const oe=(e,t)=>{f(a=>({...a,[e]:t}))},ce=async(e,t,a)=>{try{const r=await m(e,t);P(10);const s=r.filter(e=>{const t=e.profit_per_unit??e.buy_price-e.sell_price??0,r=e.max_volume??0,s=e.total_profit??t*r,n=e.profit_margin??(e.sell_price?t/e.sell_price*100:0),l=s>=parseFloat(a.minProfit||0),i=(e.sell_price??0)*r,o=!a.maxBudget||i<=parseFloat(a.maxBudget);return l&&n>=parseFloat(a.minROI||0)&&o}),n=90,l=await(async(e,t,a)=>{const[r,s]=await Promise.all([i(),o()]),n=new Map(s.map(e=>[Number(e.station_id||e.stationID),e])),l=new Map(r.map(e=>[Number(e.structureID??e.stationID),e]));if(!e||!Array.isArray(e))return[];const u=t.maxWeight?parseFloat(t.maxWeight):null,m=[],d=e.length||0;let p=0;for(const i of e){const e=await ae(i.type_id);let r=i.max_volume||0;if(u&&e.volume>0){const t=Math.floor(u/e.volume);r=Math.min(r,t)}if(t.maxBudget){const e=Number(t.maxBudget)||0,a=Number(i.sell_price||0);if(a>0){const t=Math.floor(e/a);r=Math.min(r,t)}}const s=Math.floor((r||0)*(e.volume||0));let o,h,f,y,g,x=null,b=null;if(i.origin_name&&i.destination_name)o=i.origin_name,h=i.destination_name,f=!0===(i.origin_is_npc??!0),y=!0===(i.destination_is_npc??!0),g=i.jumps??"N/A";else{const e=i.origin_id??i.from_location??i.source_station_id,a=i.destination_id??i.to_location??i.destination_station_id;x=n.get(e)||l.get(e)||{},b=n.get(a)||l.get(a)||{},!x.name&&e&&e>1e12&&K.current.add(e),!b.name&&a&&a>1e12&&K.current.add(a),o=x.name||`Unknown Station (ID: ${e})`,h=b.name||`Unknown Station (ID: ${a})`;const r=x&&("station"===x.type||1===x.is_npc||!0===x.is_npc),s=b&&("station"===b.type||1===b.is_npc||!0===b.is_npc);f=void 0===r||!!r,y=void 0===s||!!s,g=null;const u=i.origin_system_id||x?.system_id||x?.systemID||x?.solarSystemID,m=i.destination_system_id||b?.system_id||b?.systemID||b?.solarSystemID;if(u&&m&&(null!=x?.security_status&&se.current.set(u,Number(x.security_status)),null!=b?.security_status&&se.current.set(m,Number(b.security_status)),g=await ne(u,m),null==g&&"safest"===t.routePreference)){re.current.delete(`${u}->${m}:safest`);const e=await c(u,m,"shortest").catch(()=>null);e&&(g=Math.max(0,e.length-1))}}let v=i.origin_security??(x?x.security_status??x.security??null:null),j=i.destination_security??(b?b.security_status??b.security??null:null);v=null!=v?Number(v):v,j=null!=j?Number(j):j;const N=i.profit_per_jump??(g&&"number"==typeof g&&g>0?(i.profit_per_unit||0)*r/g:null);m.push({Item:i.name||e.name,From:{name:o,security:v,isNPC:f,systemId:i.origin_system_id||(x?x.system_id:null)},To:{name:h,security:j,isNPC:y,systemId:i.destination_system_id||(b?b.system_id:null)},"Buy Price":i.sell_price||0,"Sell Price":i.buy_price||0,"Profit Per Unit":i.profit_per_unit||0,"Profit Percentage":i.profit_margin||0,Quantity:r,"Total Capacity (m3)":s,"Item Volume":i.volume||e.volume,Jumps:g,"Profit per Jump":N,"Total Profit":i.total_profit||(i.profit_per_unit||0)*r,ROI:i.profit_margin,_rawData:i}),p++,a&&d>0&&(p!==d&&p%5!=0||a(p/d))}let h=m;h=h.filter(e=>(Number(e.Quantity)||0)>0);const f="number"==typeof t.salesTax?t.salesTax:7.5;h=h.map(e=>{const t=Number(e.Quantity)||0,a=Number(e["Sell Price"])||0,r=(Number(e["Total Profit"])||0)-f/100*a*t;return{...e,"Total Profit":r,"Net Profit":r}});const y=parseFloat(t.minProfit||"0"),g=parseFloat(t.minROI||"0"),x=t.maxBudget?parseFloat(t.maxBudget):null;if(h=h.filter(e=>{const t=Number(e.Quantity)||0,a=(Number(e["Buy Price"])||0)*t,r=Number(e["Total Profit"])||0,s=Number(e["Profit Percentage"])||0;return(null==x||a<=x)&&r>=y&&s>=g}),t.securityStatus&&"any"!==t.securityStatus){const e=e=>"number"==typeof e&&e>=.5,a=e=>"number"==typeof e&&e>0&&e<.5,r=e=>"number"==typeof e&&e<=0;h=h.filter(s=>{const n=s.From?.security,l=s.To?.security;return null!=n&&null!=l&&("highsec"===t.securityStatus?e(n)&&e(l):"lowsec"===t.securityStatus?a(n)&&a(l):"nullsec"!==t.securityStatus||r(n)&&r(l))})}if(t.structureType&&"all"!==t.structureType&&(h=h.filter(e=>{const a=!0===e.From?.isNPC,r=!0===e.To?.isNPC;return"avoid-player"===t.structureType?a||r:"avoid-npc"!==t.structureType||!a&&!r})),t.maxJumps){const e=Number(t.maxJumps);Number.isFinite(e)&&(h=h.filter(t=>"number"!=typeof t.Jumps||t.Jumps<=e))}return h})(s,a,e=>{const t=10+Math.min(1,Math.max(0,e))*n;P(e=>t>e?Math.round(t):e)});return P(100),l}catch(r){throw new Error("Failed to fetch market orders.")}},ue=e=>{E(t=>t.key===e?{key:e,direction:"asc"===t.direction?"desc":"asc"}:{key:e,direction:"asc"})},me=t.useMemo(()=>{if(!L.key)return _;const e=[..._];return e.sort((e,t)=>{const a=(e,t)=>{switch(t){case"Item":return e.Item||"";case"From":return e.From&&e.From.name||e.From||"";case"To":return e.To&&e.To.name||e["Take To"]||"";case"Quantity":return e.Quantity||0;case"Buy Price":return e["Buy Price"]||0;case"Total Buy Price":return(e["Buy Price"]||0)*(e.Quantity||0);case"Sell Price":return e["Sell Price"]||0;case"Net Profit":return e["Total Profit"]||0;case"Jumps":return"number"==typeof e.Jumps?e.Jumps:0;case"Profit per Jump":return"number"==typeof e.Jumps&&e["Total Profit"]?e["Total Profit"]/e.Jumps:0;case"Profit Per Item":return e["Profit Per Unit"]||0;case"ROI":return e["Profit Percentage"]||0;case"Total Capacity (m³)":return e["Total Capacity (m3)"]||0;default:return e[t]||""}},r=a(e,L.key),s=a(t,L.key);return"number"==typeof r&&"number"==typeof s?"asc"===L.direction?r-s:s-r:"asc"===L.direction?String(r).localeCompare(String(s)):String(s).localeCompare(String(r))}),e},[_,L]);t.useEffect(()=>{let e=!0;const t=async()=>{try{const t=await l();e&&t&&U(new Date(t).getTime())}catch{}};t();const a=setInterval(t,6e4),r=setInterval(()=>q(Date.now()),1e3);return()=>{e=!1,clearInterval(a),clearInterval(r)}},[]),t.useEffect(()=>{G(!!(z&&W&&W>z))},[W,z]);return t.useEffect(()=>{if(!v&&100===N){const e=setTimeout(()=>P(0),1500);return()=>clearTimeout(e)}},[v,N]),y?e.jsxs("div",{className:"region-hauling",children:[e.jsx("div",{className:"static-header",children:e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{children:"Region to Region Trading"}),e.jsx("p",{className:"disclaimer",children:"This feature is still a WIP and may have issues."})]})}),e.jsxs("div",{className:"scrollable-content",children:[e.jsx("div",{className:"hauling-form",children:e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),w([]),M(1),j(!0),P(0),I(null),Q(!1),!h.fromRegion?.regionID||!h.toRegion?.regionID)return I("Please select both source and destination regions"),void j(!1);try{const e=Number(h.fromRegion.regionID),t=Number(h.toRegion.regionID),a=await ce(e,t,h);a.length>0?(w(a),T(a.some(e=>e._rawData&&e._rawData._fallback)),Q(!0),W&&X(W)):I("No profitable trades found for the selected criteria.")}catch(t){I(t.message)}finally{j(!1)}},children:[e.jsxs("div",{className:"form-container",children:[e.jsxs("div",{className:"form-row top-row-fixed-6",children:[e.jsxs("div",{className:"form-group region-group",children:[e.jsx("label",{children:"Starting Region"}),e.jsx(s,{selectedRegion:h.fromRegion,onRegionChange:e=>{f(t=>({...t,fromRegion:e,nearbyOnly:!(!t.nearbyOnly||!e)&&t.nearbyOnly}))},allowAllRegions:!1})]}),e.jsxs("div",{className:"form-group region-group",children:[e.jsx("label",{children:"Ending Region"}),h.nearbyOnly?e.jsx("div",{className:"nearby-region-display",children:"…"}):e.jsx(s,{selectedRegion:h.toRegion,onRegionChange:e=>{f(t=>({...t,toRegion:e,nearbyOnly:!1}))},allowAllRegions:!1})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Security"}),e.jsx("select",{value:h.securityStatus,onChange:e=>oe("securityStatus",e.target.value),className:"form-control",children:[{value:"any",label:"Any"},{value:"highsec",label:"High-Sec"},{value:"lowsec",label:"Low-Sec"},{value:"nullsec",label:"Null-Sec"}].map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Stations/Structures"}),e.jsx("select",{value:h.structureType,onChange:e=>oe("structureType",e.target.value),className:"form-control",children:[{value:"all",label:"All"},{value:"avoid-player",label:"Avoid Player Structures"},{value:"avoid-npc",label:"Avoid NPC Stations"}].map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Route"}),e.jsx("select",{value:h.routePreference,onChange:e=>oe("routePreference",e.target.value),className:"form-control",children:[{value:"safest",label:"Safest Route"},{value:"shortest",label:"Shortest Route"}].map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Max Jumps"}),e.jsx("input",{type:"number",value:h.maxJumps??"",onChange:e=>oe("maxJumps",e.target.value),placeholder:"∞",className:"form-control"})]})]}),e.jsxs("div",{className:"form-row second-row-fixed-5",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Max Budget"}),e.jsx("input",{type:"number",value:h.maxBudget??"",onChange:e=>oe("maxBudget",e.target.value),placeholder:"∞",className:"form-control"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Max Capacity (m³)"}),e.jsx("input",{type:"number",value:h.maxWeight??"",onChange:e=>oe("maxWeight",e.target.value),placeholder:"∞",className:"form-control"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Sales Tax"}),e.jsx("select",{value:h.salesTax,onChange:e=>oe("salesTax",Number(e.target.value)),className:"form-control",children:[{level:0,tax:7.5,label:"No Skill: 7.5%"},{level:1,tax:6.675,label:"Lvl I: 6.675%"},{level:2,tax:5.85,label:"Lvl II: 5.85%"},{level:3,tax:5.025,label:"Lvl III: 5.025%"},{level:4,tax:4.2,label:"Lvl IV: 4.2%"},{level:5,tax:3.375,label:"Lvl V: 3.375%"}].map(t=>e.jsx("option",{value:t.tax,children:t.label},t.level))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Min Profit"}),e.jsx("input",{type:"number",value:h.minProfit??"",onChange:e=>oe("minProfit",e.target.value),placeholder:"0",className:"form-control"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Min ROI %"}),e.jsx("input",{type:"number",value:h.minROI??"",onChange:e=>oe("minROI",e.target.value),placeholder:"0",className:"form-control"})]})]})]}),S&&e.jsx("div",{className:"error-message",children:S}),e.jsx("div",{className:"form-actions",children:e.jsxs("div",{className:"primary-actions",children:[e.jsxs("div",{className:"buttons-row",children:[e.jsx("button",{type:"submit",disabled:v||!h.fromRegion||!h.toRegion,className:"eve-button primary-search-btn",children:v?`Searching...${N}%`:"Find Trade Routes"}),H&&A&&e.jsx("button",{type:"button",onClick:async()=>{if(!v&&h.fromRegion?.regionID&&h.toRegion?.regionID){j(!0),P(0),I(null);try{const e=Number(h.fromRegion.regionID),t=Number(h.toRegion.regionID),a=await ce(e,t,h);a.length>0?(w(a),T(a.some(e=>e._rawData&&e._rawData._fallback)),Q(!0),W&&X(W)):I("No profitable trades found for the refreshed data.")}catch(e){I(e.message||"Failed to refresh results")}finally{j(!1)}}},disabled:v,className:"eve-button refresh-btn",title:"New data is available. Click to refresh results.",children:v?`Refreshing…${N}%`:"New Data Available – Refresh"})]}),e.jsxs("div",{className:"update-timer-container",title:W?new Date(W).toLocaleString():"",children:[e.jsx("span",{className:"update-timer-label",children:"Time Since Last Update:"}),e.jsx("span",{className:"update-timer-value",children:(()=>{if(!W)return"—";const e=Math.max(0,V-W);return`${Math.floor(e/6e4)}m ${Math.floor(e%6e4/1e3)}s`})()})]})]})})]})}),A&&me.length>0&&e.jsxs("div",{className:"results-container",children:[e.jsxs("div",{className:"results-header",children:[e.jsxs("h2",{children:["Trade Route Results (",me.length," found)"]}),e.jsx("button",{onClick:()=>{w([]),I(null),M(1),T(!1),Q(!1)},className:"eve-button clear-results-btn",type:"button",children:"Clear Results"})]}),e.jsxs("div",{className:"results-table-container",children:[e.jsxs("table",{className:"results-table wide-table",style:{tableLayout:"fixed"},children:[e.jsx("colgroup",{children:Object.keys(Y).map(t=>e.jsx("col",{style:{width:`${Y[t]}px`,minWidth:`${Y[t]}px`}},t))}),e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(ee,{label:"Item"}),e.jsx(ee,{label:"From"}),e.jsx(ee,{label:"Quantity"}),e.jsx(ee,{label:"Buy Price"}),e.jsx(ee,{label:"Total Buy Price"}),e.jsx(ee,{label:"To"}),e.jsx(ee,{label:"Sell Price"}),e.jsx(ee,{label:"Net Profit"}),e.jsx(ee,{label:"Jumps"}),e.jsx(ee,{label:"Profit per Jump"}),e.jsx(ee,{label:"Profit Per Item"}),e.jsx(ee,{label:"ROI"}),e.jsx(ee,{label:"Total Capacity (m³)"})]})}),e.jsx("tbody",{children:(()=>{const t=(D-1)*F,a=t+F;return me.slice(t,a).map((a,r)=>{const s=a.Item||"Unknown Item",l=a.From||{},i=a.To||a["Take To"]||{},o=a["Buy Price"]||0,c=a.Quantity||0,u=o*c,m=a["Sell Price"]||0,p=a["Total Profit"]||0,h="number"==typeof a.Jumps?a.Jumps:"—",f=a["Profit per Jump"],y=a["Profit Per Unit"]||0,g=a["Profit Percentage"]||0,x=a["Total Capacity (m3)"]||0,b=l.security,v=i.security,j=(e,t=2)=>d(e,t);return e.jsxs("tr",{children:[e.jsx("td",{style:{...te("Item"),whiteSpace:"normal",overflow:"visible"},className:"clickable-location wrap-cell",title:`Copy: ${s}`,onClick:()=>le(s),children:s}),e.jsx("td",{style:{...te("From"),whiteSpace:"normal",overflow:"visible"},className:"clickable-location wrap-cell",onClick:()=>le(l.name),title:`Copy: ${l.name}`,children:e.jsx("span",{style:{color:n(b)},children:l.name})}),e.jsx("td",{style:{...te("Quantity"),textAlign:"left"},children:j(c,0)}),e.jsx("td",{style:te("Buy Price"),children:j(o,2)}),e.jsx("td",{style:te("Total Buy Price"),children:j(u,2)}),e.jsx("td",{style:{...te("To"),whiteSpace:"normal",overflow:"visible"},className:"clickable-location wrap-cell",onClick:()=>le(i.name),title:`Copy: ${i.name}`,children:e.jsx("span",{style:{color:n(v)},children:i.name})}),e.jsx("td",{style:te("Sell Price"),children:j(m,2)}),e.jsx("td",{style:te("Net Profit"),children:j(p,2)}),e.jsx("td",{style:{...te("Jumps"),textAlign:"left"},children:h}),e.jsx("td",{style:te("Profit per Jump"),children:null!=f?j(f,2):"—"}),e.jsx("td",{style:te("Profit Per Item"),children:j(y,2)}),e.jsxs("td",{style:te("ROI"),children:[j(g,2),"%"]}),e.jsx("td",{style:te("Total Capacity (m³)"),children:j(x,0)})]},t+r)})})()})]}),R&&e.jsx("div",{className:"fallback-banner",title:"Routes derived from raw snapshots (no precomputed hauling cache)",children:"Using snapshot-derived fallback routing data."})]}),me.length>F&&e.jsx("div",{className:"pagination-container",children:e.jsxs("div",{className:"pagination",children:[e.jsx("button",{className:"pagination-btn",onClick:()=>M(e=>Math.max(1,e-1)),disabled:1===D,type:"button",children:"Previous"}),e.jsxs("div",{className:"pagination-info",children:["Page ",D," of ",Math.ceil(me.length/F)]}),e.jsx("button",{className:"pagination-btn",onClick:()=>M(e=>Math.min(Math.ceil(me.length/F),e+1)),disabled:D===Math.ceil(me.length/F),type:"button",children:"Next"})]})})]}),e.jsx("button",{type:"button",className:"eve-button return-to-top-btn no-notch",onClick:()=>{const e=document.querySelector(".region-hauling");e?e.scrollTo({top:0,behavior:"smooth"}):window.scrollTo({top:0,behavior:"smooth"})},"aria-label":"Return to top",children:"Top"})]})]}):e.jsx("div",{className:"region-hauling",children:e.jsx("div",{className:"loading-container",children:e.jsx("p",{children:"Loading regions..."})})})}export{h as default};
