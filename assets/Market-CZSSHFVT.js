import{j as e}from"./index-CiZ_y1LZ.js";import{r as t,b as n,u as i}from"./react-vendor-qWGkjVPF.js";import{R as s,f as r,g as o,c as l,a,b as c,t as d,d as u,e as m,h,i as g,j as f}from"./common-0CtYHdO5.js";import{G as p}from"./icons-D27Cx8XS.js";import{u as y,f as b,g as x,a as v,b as S,c as w}from"./index-Dikt98rE.js";import{R as j,C as N,X as k,Y as C,T as I,L as E,B as z,a as M,b as _,A as D}from"./chart-vendor-CUpBoK-B.js";import{f as R,a as A,b as O}from"./market-CK_Tq7vn.js";function F({marketTree:n,expandedNodes:i,setExpandedNodes:s,onItemSelect:r}){const[o,l]=t.useState(""),[a,c]=t.useState([]);t.useEffect(()=>{if(o.length>=4){const e=function(e,t){const n=[],i=new Set;function s(t){if(null!==t&&"object"==typeof t&&!i.has(t)){if(i.add(t),Array.isArray(t.items)){const i=t.items.filter(t=>t.typeName?.toLowerCase().includes(e.toLowerCase()));n.push(...i)}for(const[e,n]of Object.entries(t))["_info","items"].includes(e)||s(n)}}return Array.isArray(t)?t.forEach(s):s(t),n}(o,n),t=e.sort((e,t)=>e.typeName.localeCompare(t.typeName));c(t)}else c([])},[o,n]);const d=t.useRef();t.useEffect(()=>{function e(e){d.current&&!d.current.contains(e.target)&&c([])}function t(e){"Escape"===e.key&&c([])}return document.addEventListener("mousedown",e),document.addEventListener("keydown",t),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",t)}},[]);const u=e=>{const t=T(e.typeID,n);if(t){const e=new Set(i);t.reduce((t,n)=>{const i=[...t,n].join("/");return e.add(i),[...t,n]},[]),s(e)}r(e),c([]),l(e.typeName)};return e.jsxs("div",{className:"search-bar",ref:d,children:[e.jsx("input",{type:"text",placeholder:"Search",value:o,onChange:e=>{const t=e.target.value;l(t)},onKeyDown:e=>{if("Enter"===e.key){const e=a.find(e=>e.typeName===o);e&&u(e)}}}),e.jsx("span",{className:"search-clear",title:"Clear Search",onClick:()=>{l(""),c([])},children:"╳"}),o.length>=4&&a.length>0&&e.jsx("ul",{className:"search-suggestions",children:a.map(t=>e.jsx("li",{onClick:()=>u(t),className:"suggestion-item",children:t.typeName},t.typeID))})]})}function T(e,t,n=[],i=new Set){if(null===t||"object"!=typeof t)return null;if(i.has(t))return null;i.add(t);for(const[s,r]of Object.entries(t)){if("object"!=typeof r||null===r)continue;const t=[...n,s];if(Array.isArray(r.items)){if(r.items.find(t=>String(t.typeID)===String(e)))return t}for(const[n,s]of Object.entries(r)){if(["_info","items"].includes(n))continue;if("object"!=typeof s||null===s)continue;const r=T(e,s,[...t,n],i);if(r)return r}}return null}const L="eveQuickbar";function V({onItemSelect:n}){const[i,s]=t.useState([]);t.useEffect(()=>{const e=localStorage.getItem(L);if(e)try{s(JSON.parse(e))}catch(t){}},[]),t.useEffect(()=>{const e=e=>{const t=e.detail;s(e=>{if(e.some(e=>e.typeID===t.typeID))return e;const n=[...e,t];return localStorage.setItem(L,JSON.stringify(n)),n})};return window.addEventListener("quickbar:add",e),()=>window.removeEventListener("quickbar:add",e)},[]);return 0===i.length?e.jsxs("div",{className:"quickbar-empty",children:[e.jsx("p",{children:"No items in quickbar"}),e.jsx("p",{className:"quickbar-hint",children:"Hover over items in the market tree and click the + button to add them here"})]}):e.jsx("div",{className:"quickbar",children:i.map(t=>e.jsxs("div",{className:"quickbar-item",children:[e.jsxs("div",{className:"quickbar-item-name",onClick:()=>n?.(t),children:[e.jsx("img",{src:`https://images.evetech.net/types/${t.typeID}/icon?size=32`,alt:"",className:"quickbar-item-icon"}),e.jsx("span",{children:t.typeName})]}),e.jsx("button",{className:"quickbar-remove-btn",onClick:()=>{return e=t.typeID,void s(t=>{const n=t.filter(t=>t.typeID!==e);return localStorage.setItem(L,JSON.stringify(n)),n});var e},title:"Remove from quickbar",children:"×"})]},t.typeID))})}const P="marketTreeState",$="selectedItemID";function U({node:t,nodeName:n,path:i,onItemSelect:s,expandedNodes:r,toggleNode:o}){const l=[...i,n],a=l.join("/"),c=r.has(a),d=Object.keys(t).some(e=>!["_info","items","name"].includes(e)),u=Array.isArray(t.items)&&t.items.length>0;return e.jsxs("li",{children:[e.jsxs("div",{className:"tree-group-header",onClick:()=>o(a),children:[t._info?.iconFile&&e.jsx("img",{src:t._info?.iconFile?`/EVE-Data-Site/assets/marketGroupIcons/${t._info.iconFile}`:"/EVE-Data-Site/assets/marketGroupIcons/defaultGroupIcon.png",alt:"",className:"group-icon",onError:e=>{e.target.onerror=null,e.target.src="/EVE-Data-Site/assets/marketGroupIcons/defaultGroupIcon.png"}}),n]}),c&&e.jsxs(e.Fragment,{children:[u&&e.jsx("ul",{children:t.items.map(t=>e.jsxs("li",{className:"market-item with-button",children:[e.jsx("span",{id:`item-${t.typeID}`,className:"item-name",onClick:()=>{localStorage.setItem($,t.typeID),s?.(t)},children:t.typeName}),e.jsx("button",{className:"quickbar-add-btn",title:"Add to Quickbar",onClick:e=>{e.stopPropagation(),window.dispatchEvent(new CustomEvent("quickbar:add",{detail:{typeID:t.typeID,typeName:t.typeName,groupID:t.groupID,categoryID:t.categoryID}}))},children:"+"})]},t.typeID))}),d&&e.jsx("ul",{children:Object.entries(t).map(([t,n])=>"_info"===t||"items"===t||"name"===t?null:e.jsx(U,{node:n,nodeName:t,path:l,onItemSelect:s,expandedNodes:r,toggleNode:o},[...l,t].join("/")))})]})]})}function W({marketTree:n,onItemSelect:i,breadcrumbPath:s,collapseVersion:r}){const[o,l]=t.useState(new Set);function a(e){l(t=>{const n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n})}function c(e){l(t=>{const n=new Set(t);for(let i=0;i<e.length;i++){const t=e.slice(0,i+1).join("/");n.add(t)}return n})}return t.useEffect(()=>{const e=localStorage.getItem(P);if(e)try{l(new Set(JSON.parse(e)))}catch(t){}},[]),t.useEffect(()=>{void 0!==r&&(l(new Set),localStorage.setItem(P,JSON.stringify([])))},[r]),t.useEffect(()=>{localStorage.setItem(P,JSON.stringify([...o]))},[o]),t.useEffect(()=>{s&&s.length>0&&l(e=>{const t=new Set(e);for(let n=0;n<s.length;n++){const e=s.slice(0,n+1).join("/");t.add(e)}return t})},[s]),t.useEffect(()=>{"undefined"!=typeof window&&(window.marketTreeNavigate=c)},[]),t.useEffect(()=>{if(!s||0===s.length||!n)return;const e=localStorage.getItem($);e&&setTimeout(()=>{const t=document.getElementById(`item-${e}`);t&&t.scrollIntoView({behavior:"smooth",block:"center"})},100)},[s,n]),n?e.jsx("ul",{className:"menuList menuListtop",children:n.map((t,n)=>e.jsx(U,{node:t,nodeName:t.name,path:[],onItemSelect:i,expandedNodes:o,toggleNode:a},t.name||n))}):null}function K({selectedRegion:n,onRegionChange:i,regions:r,onItemSelect:o,marketTree:l,breadcrumbPath:a}){const[c,d]=t.useState("market"),[u,m]=t.useState(new Set),h=t.useRef(null),g=t.useRef(null),f=t.useRef(null);t.useEffect(()=>{const e=()=>{const e=h.current,t="market"===c?g.current:f.current;e&&t&&(e.style.setProperty("--underline-x",`${t.offsetLeft}px`),e.style.setProperty("--underline-width",`${t.offsetWidth}px`))},t=setTimeout(e,10);return window.addEventListener("resize",e),()=>{clearTimeout(t),window.removeEventListener("resize",e)}},[c]);const[p,y]=t.useState(0),b=e=>d(e);return e.jsxs("aside",{id:"sidebar",className:"sidebar",children:[e.jsxs("div",{className:"sidebar-header",children:[e.jsx("div",{className:"regionSelector-wrapper",children:e.jsx(s,{selectedRegion:n,onRegionChange:i,regions:r})}),e.jsxs("div",{className:"search-wrapper",children:[e.jsx(F,{marketTree:l,expandedNodes:u,setExpandedNodes:m,onItemSelect:o}),e.jsx("button",{className:"collapse-button",title:"Collapse all groups",onClick:()=>{m(new Set),y(e=>e+1)},children:e.jsx("img",{src:"/EVE-Data-Site/assets/collapse.png",alt:"Collapse"})})]}),e.jsx("div",{className:"tab-container",ref:h,children:e.jsxs("div",{className:"sidebar-tabs",children:[e.jsx("button",{ref:g,className:"sidebar-tab-link "+("market"===c?"active":""),onClick:()=>b("market"),children:"Market"}),e.jsx("button",{ref:f,className:"sidebar-tab-link "+("quickbar"===c?"active":""),onClick:()=>b("quickbar"),children:"Quickbar"})]})})]}),e.jsxs("div",{className:"sidebar-scrollable",children:["market"===c&&l&&e.jsx(W,{marketTree:l,onItemSelect:o,breadcrumbPath:a,collapseVersion:p}),"quickbar"===c&&e.jsx(V,{onItemSelect:o})]})]})}function q(e){return p({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polyline",attr:{points:"20 6 9 17 4 12"},child:[]}]})(e)}function B(e){return p({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polygon",attr:{points:"22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"},child:[]}]})(e)}function H(e){return p({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"},child:[]},{tag:"path",attr:{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"},child:[]}]})(e)}function X(e){return p({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"line",attr:{x1:"18",y1:"6",x2:"6",y2:"18"},child:[]},{tag:"line",attr:{x1:"6",y1:"6",x2:"18",y2:"18"},child:[]}]})(e)}function Q({selectedItem:n,marketTree:i,onBreadcrumbClick:s}){const[r,o]=t.useState([]),[l,a]=t.useState(!1);t.useEffect(()=>{if(n?.typeID&&i){const e=function(e,t){const n=Number(e);let i=[];function s(e){return Array.isArray(e)&&e.some(e=>e&&"object"==typeof e&&Number(e.typeID)===n)}function r(e){return e}function o(e,t=[],n){if(!e||"object"!=typeof e)return!1;if(0===t.length&&n){t=[{key:n,name:r(n)}]}if(s(e.items))return i=t.map(e=>e.name),!0;for(const[r,o]of Object.entries(e))if("_info"!==r&&"items"!==r&&Array.isArray(o)&&s(o))return i=t.map(e=>e.name),!0;for(const[i,s]of Object.entries(e))if("_info"!==i&&"items"!==i&&s&&"object"==typeof s&&!Array.isArray(s)){const e=r(i);if(o(s,[...t,{key:i,name:e}],i))return!0}return!1}if(Array.isArray(t)){for(const l of t)if(l&&"object"==typeof l){if(o(l,[],l.name||"Unknown"))return i}}else for(const[l,a]of Object.entries(t))if(a&&"object"==typeof a&&!Array.isArray(a)&&o(a,[],l))return i;return["Unknown Category"]}(n.typeID,i);o(e)}},[n,i]);const c=`https://images.evetech.net/types/${n?.typeID}/icon?size=64`;return n?e.jsxs("div",{className:"item-viewer",children:[e.jsx("img",{src:c,alt:n.typeName,className:"item-icon",onError:e=>e.target.src="/assets/fallback_icon.png"}),e.jsxs("div",{className:"item-details",children:[e.jsx("div",{className:"breadcrumb",children:r.map((t,n)=>e.jsxs("span",{children:[e.jsx("a",{href:"#",onClick:e=>{e.preventDefault(),s(r.slice(0,n+1))},children:t}),n<r.length-1&&e.jsx("span",{children:" / "})]},n))}),e.jsxs("div",{className:"item-header-row",children:[e.jsx("div",{className:"item-name",children:n.typeName}),e.jsx("button",{className:"quickbar-btn",onClick:()=>{const e="eveQuickbar",t=JSON.parse(localStorage.getItem(e)||"[]");t.some(e=>e.typeID===n.typeID)||(localStorage.setItem(e,JSON.stringify([...t,n])),window.dispatchEvent(new CustomEvent("quickbar:add",{detail:n})))},title:"Add to Quickbar",style:{minWidth:"140px",padding:"8px 14px",textAlign:"center"},children:"Add to Quickbar"}),e.jsxs("div",{style:{position:"relative"},children:[e.jsx("button",{onClick:async()=>{const e=`${`${window.location.origin}/EVE-Data-Site/market`}?item=${n.typeID}`;try{await navigator.clipboard.writeText(e),a(!0),setTimeout(()=>a(!1),2e3)}catch(t){}},className:"item-link",title:"Copy market link (opens item on load)",children:l?e.jsx(q,{className:"icon"}):e.jsx(H,{className:"icon"})}),l&&e.jsx("div",{className:"copy-tooltip",style:{top:"-30px",left:"0"},children:"Link copied!"})]})]})]})]}):null}function J(e,t,n){let i,s=n.initialDeps??[];function r(){var r,o,l,a;let c;n.key&&(null==(r=n.debug)?void 0:r.call(n))&&(c=Date.now());const d=e();if(!(d.length!==s.length||d.some((e,t)=>s[t]!==e)))return i;let u;if(s=d,n.key&&(null==(o=n.debug)?void 0:o.call(n))&&(u=Date.now()),i=t(...d),n.key&&(null==(l=n.debug)?void 0:l.call(n))){Math.round(100*(Date.now()-c)),Math.round(100*(Date.now()-u))}return null==(a=null==n?void 0:n.onChange)||a.call(n,i),i}return r.updateDeps=e=>{s=e},r}function G(e,t){if(void 0===e)throw new Error("Unexpected undefined");return e}const Y=(e,t,n)=>{let i;return function(...s){e.clearTimeout(i),i=e.setTimeout(()=>t.apply(this,s),n)}},Z=e=>{const{offsetWidth:t,offsetHeight:n}=e;return{width:t,height:n}},ee=e=>e,te=e=>{const t=Math.max(e.startIndex-e.overscan,0),n=Math.min(e.endIndex+e.overscan,e.count-1),i=[];for(let s=t;s<=n;s++)i.push(s);return i},ne=(e,t)=>{const n=e.scrollElement;if(!n)return;const i=e.targetWindow;if(!i)return;const s=e=>{const{width:n,height:i}=e;t({width:Math.round(n),height:Math.round(i)})};if(s(Z(n)),!i.ResizeObserver)return()=>{};const r=new i.ResizeObserver(t=>{const i=()=>{const e=t[0];if(null==e?void 0:e.borderBoxSize){const t=e.borderBoxSize[0];if(t)return void s({width:t.inlineSize,height:t.blockSize})}s(Z(n))};e.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(i):i()});return r.observe(n,{box:"border-box"}),()=>{r.unobserve(n)}},ie={passive:!0},se="undefined"==typeof window||"onscrollend"in window,re=(e,t)=>{const n=e.scrollElement;if(!n)return;const i=e.targetWindow;if(!i)return;let s=0;const r=e.options.useScrollendEvent&&se?()=>{}:Y(i,()=>{t(s,!1)},e.options.isScrollingResetDelay),o=i=>()=>{const{horizontal:o,isRtl:l}=e.options;s=o?n.scrollLeft*(l?-1:1):n.scrollTop,r(),t(s,i)},l=o(!0),a=o(!1);a(),n.addEventListener("scroll",l,ie);const c=e.options.useScrollendEvent&&se;return c&&n.addEventListener("scrollend",a,ie),()=>{n.removeEventListener("scroll",l),c&&n.removeEventListener("scrollend",a)}},oe=(e,t,n)=>{if(null==t?void 0:t.borderBoxSize){const e=t.borderBoxSize[0];if(e){return Math.round(e[n.options.horizontal?"inlineSize":"blockSize"])}}return e[n.options.horizontal?"offsetWidth":"offsetHeight"]},le=(e,{adjustments:t=0,behavior:n},i)=>{var s,r;const o=e+t;null==(r=null==(s=i.scrollElement)?void 0:s.scrollTo)||r.call(s,{[i.options.horizontal?"left":"top"]:o,behavior:n})};class ae{constructor(e){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let e=null;const t=()=>e||(this.targetWindow&&this.targetWindow.ResizeObserver?e=new this.targetWindow.ResizeObserver(e=>{e.forEach(e=>{const t=()=>{this._measureElement(e.target,e)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(t):t()})}):null);return{disconnect:()=>{var n;null==(n=t())||n.disconnect(),e=null},observe:e=>{var n;return null==(n=t())?void 0:n.observe(e,{box:"border-box"})},unobserve:e=>{var n;return null==(n=t())?void 0:n.unobserve(e)}}})(),this.range=null,this.setOptions=e=>{Object.entries(e).forEach(([t,n])=>{void 0===n&&delete e[t]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:ee,rangeExtractor:te,onChange:()=>{},measureElement:oe,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...e}},this.notify=e=>{var t,n;null==(n=(t=this.options).onChange)||n.call(t,this,e)},this.maybeNotify=J(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),e=>{this.notify(e)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(e=>e()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var e;const t=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==t){if(this.cleanup(),!t)return void this.maybeNotify();this.scrollElement=t,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=(null==(e=this.scrollElement)?void 0:e.window)??null,this.elementsCache.forEach(e=>{this.observer.observe(e)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,e=>{this.scrollRect=e,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(e,t)=>{this.scrollAdjustments=0,this.scrollDirection=t?this.getScrollOffset()<e?"forward":"backward":null,this.scrollOffset=e,this.isScrolling=t,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??("function"==typeof this.options.initialOffset?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(e,t)=>{const n=new Map,i=new Map;for(let s=t-1;s>=0;s--){const t=e[s];if(n.has(t.lane))continue;const r=i.get(t.lane);if(null==r||t.end>r.end?i.set(t.lane,t):t.end<r.end&&n.set(t.lane,!0),n.size===this.options.lanes)break}return i.size===this.options.lanes?Array.from(i.values()).sort((e,t)=>e.end===t.end?e.index-t.index:e.end-t.end)[0]:void 0},this.getMeasurementOptions=J(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(e,t,n,i,s)=>(this.pendingMeasuredCacheIndexes=[],{count:e,paddingStart:t,scrollMargin:n,getItemKey:i,enabled:s}),{key:!1}),this.getMeasurements=J(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:e,paddingStart:t,scrollMargin:n,getItemKey:i,enabled:s},r)=>{if(!s)return this.measurementsCache=[],this.itemSizeCache.clear(),[];0===this.measurementsCache.length&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(e=>{this.itemSizeCache.set(e.key,e.size)}));const o=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const l=this.measurementsCache.slice(0,o);for(let a=o;a<e;a++){const e=i(a),s=1===this.options.lanes?l[a-1]:this.getFurthestMeasurement(l,a),o=s?s.end+this.options.gap:t+n,c=r.get(e),d="number"==typeof c?c:this.options.estimateSize(a),u=o+d,m=s?s.lane:a%this.options.lanes;l[a]={index:a,start:o,size:d,end:u,key:e,lane:m}}return this.measurementsCache=l,l},{key:!1,debug:()=>this.options.debug}),this.calculateRange=J(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(e,t,n,i)=>this.range=e.length>0&&t>0?function({measurements:e,outerSize:t,scrollOffset:n,lanes:i}){const s=e.length-1,r=t=>e[t].start;if(e.length<=i)return{startIndex:0,endIndex:s};let o=ce(0,s,r,n),l=o;if(1===i)for(;l<s&&e[l].end<n+t;)l++;else if(i>1){const r=Array(i).fill(0);for(;l<s&&r.some(e=>e<n+t);){const t=e[l];r[t.lane]=t.end,l++}const a=Array(i).fill(n+t);for(;o>=0&&a.some(e=>e>=n);){const t=e[o];a[t.lane]=t.start,o--}o=Math.max(0,o-o%i),l=Math.min(s,l+(i-1-l%i))}return{startIndex:o,endIndex:l}}({measurements:e,outerSize:t,scrollOffset:n,lanes:i}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=J(()=>{let e=null,t=null;const n=this.calculateRange();return n&&(e=n.startIndex,t=n.endIndex),this.maybeNotify.updateDeps([this.isScrolling,e,t]),[this.options.rangeExtractor,this.options.overscan,this.options.count,e,t]},(e,t,n,i,s)=>null===i||null===s?[]:e({startIndex:i,endIndex:s,overscan:t,count:n}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=e=>{const t=this.options.indexAttribute,n=e.getAttribute(t);return n?parseInt(n,10):-1},this._measureElement=(e,t)=>{const n=this.indexFromElement(e),i=this.measurementsCache[n];if(!i)return;const s=i.key,r=this.elementsCache.get(s);r!==e&&(r&&this.observer.unobserve(r),this.observer.observe(e),this.elementsCache.set(s,e)),e.isConnected&&this.resizeItem(n,this.options.measureElement(e,t,this))},this.resizeItem=(e,t)=>{const n=this.measurementsCache[e];if(!n)return;const i=t-(this.itemSizeCache.get(n.key)??n.size);0!==i&&((void 0!==this.shouldAdjustScrollPositionOnItemSizeChange?this.shouldAdjustScrollPositionOnItemSizeChange(n,i,this):n.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=i,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(n.index),this.itemSizeCache=new Map(this.itemSizeCache.set(n.key,t)),this.notify(!1))},this.measureElement=e=>{e?this._measureElement(e,void 0):this.elementsCache.forEach((e,t)=>{e.isConnected||(this.observer.unobserve(e),this.elementsCache.delete(t))})},this.getVirtualItems=J(()=>[this.getVirtualIndexes(),this.getMeasurements()],(e,t)=>{const n=[];for(let i=0,s=e.length;i<s;i++){const s=t[e[i]];n.push(s)}return n},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=e=>{const t=this.getMeasurements();if(0!==t.length)return G(t[ce(0,t.length-1,e=>G(t[e]).start,e)])},this.getOffsetForAlignment=(e,t,n=0)=>{const i=this.getSize(),s=this.getScrollOffset();"auto"===t&&(t=e>=s+i?"end":"start"),"center"===t?e+=(n-i)/2:"end"===t&&(e-=i);const r=this.getTotalSize()+this.options.scrollMargin-i;return Math.max(Math.min(r,e),0)},this.getOffsetForIndex=(e,t="auto")=>{e=Math.max(0,Math.min(e,this.options.count-1));const n=this.measurementsCache[e];if(!n)return;const i=this.getSize(),s=this.getScrollOffset();if("auto"===t)if(n.end>=s+i-this.options.scrollPaddingEnd)t="end";else{if(!(n.start<=s+this.options.scrollPaddingStart))return[s,t];t="start"}const r="end"===t?n.end+this.options.scrollPaddingEnd:n.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(r,t,n.size),t]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(e,{align:t="start",behavior:n}={})=>{"smooth"===n&&this.isDynamicMode(),this._scrollToOffset(this.getOffsetForAlignment(e,t),{adjustments:void 0,behavior:n})},this.scrollToIndex=(e,{align:t="auto",behavior:n}={})=>{"smooth"===n&&this.isDynamicMode(),e=Math.max(0,Math.min(e,this.options.count-1));let i=0;const s=t=>{if(!this.targetWindow)return;const i=this.getOffsetForIndex(e,t);if(!i)return;const[s,o]=i;this._scrollToOffset(s,{adjustments:void 0,behavior:n}),this.targetWindow.requestAnimationFrame(()=>{const t=this.getScrollOffset(),n=this.getOffsetForIndex(e,o);var i,s;n&&(i=n[0],s=t,Math.abs(i-s)<1.01||r(o))})},r=e=>{this.targetWindow&&(i++,i<10&&this.targetWindow.requestAnimationFrame(()=>s(e)))};s(t)},this.scrollBy=(e,{behavior:t}={})=>{"smooth"===t&&this.isDynamicMode(),this._scrollToOffset(this.getScrollOffset()+e,{adjustments:void 0,behavior:t})},this.getTotalSize=()=>{var e;const t=this.getMeasurements();let n;if(0===t.length)n=this.options.paddingStart;else if(1===this.options.lanes)n=(null==(e=t[t.length-1])?void 0:e.end)??0;else{const e=Array(this.options.lanes).fill(null);let i=t.length-1;for(;i>=0&&e.some(e=>null===e);){const n=t[i];null===e[n.lane]&&(e[n.lane]=n.end),i--}n=Math.max(...e.filter(e=>null!==e))}return Math.max(n-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(e,{adjustments:t,behavior:n})=>{this.options.scrollToFn(e,{behavior:n,adjustments:t},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(e)}}const ce=(e,t,n,i)=>{for(;e<=t;){const s=(e+t)/2|0,r=n(s);if(r<i)e=s+1;else{if(!(r>i))return s;t=s-1}}return e>0?e-1:0};const de="undefined"!=typeof document?t.useLayoutEffect:t.useEffect;function ue(e){return function(e){const i=t.useReducer(()=>({}),{})[1],s={...e,onChange:(t,s)=>{var r;s?n.flushSync(i):i(),null==(r=e.onChange)||r.call(e,t,s)}},[r]=t.useState(()=>new ae(s));return r.setOptions(s),de(()=>r._didMount(),[]),de(()=>r._willUpdate()),r}({observeElementRect:ne,observeElementOffset:re,scrollToFn:le,...e})}function me({sellers:n,buyers:i,selectedRegion:s,locationInfoMap:u,activeTab:m,setActiveTab:h,itemName:g}){const[f,p]=t.useState({seller:null,buyer:null}),[j,N]=t.useState({seller:{},buyer:{}}),[k,C]=t.useState({seller:{},buyer:{}}),[I,E]=t.useState(new Set),z=t.useRef(null),[M,_]=t.useState({sellerSorting:[{id:"price",desc:!1}],buyerSorting:[{id:"price",desc:!0}],sellerSizing:{},buyerSizing:{},sellerColumnFilters:[],buyerColumnFilters:[]}),D=t.useRef(),R=t.useRef();t.useEffect(()=>{const e=e=>{z.current&&!z.current.contains(e.target)&&(p(e=>({...e,seller:null,buyer:null})),C(e=>({...e,seller:{},buyer:{}})))};return document.addEventListener("mousedown",e),document.addEventListener("touchstart",e),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("touchstart",e)}},[]);const A=(e,t,n)=>{if(!n||0===n.length)return!0;let i=e.getValue(t);if("security"===t){i=`${d(Number(i)||0).toFixed(1)}`}else if("station_type"===t){const t=Number(e.original.location_id);i=u[t]?.isNPC??t<1e12?"NPC":"Player"}else if("location_name"===t){const e=u[Number(i)];i=l(e?.name||"")}else if("region_name"===t){const e=u[Number(i)];i=l(e?.regionName||"")}else"range"===t&&(i=c(i));return n.includes(String(i))},O=async(e,t)=>{const n=u[Number(e)],i=n?.name;if(!i)return;await(async e=>{try{return await navigator.clipboard.writeText(e),!0}catch(t){return!1}})(i)&&(E(e=>new Set(e).add(t)),setTimeout(()=>{E(e=>{const n=new Set(e);return n.delete(t),n})},2e3))},F=(e,t)=>{const n=new Set;return e.forEach(e=>{if("security"===t){const t=u[Number(e.location_id)]?.security;if(null!=t){const e=d(t);n.add(`${e.toFixed(1)}`)}}else if("station_type"===t){const t=Number(e.location_id),i=u[t]?.isNPC??t<1e12;n.add(i?"NPC":"Player")}else if("location_name"===t){const t=u[Number(e.location_id)]?.name;t&&n.add(l(t))}else if("region_name"===t){const t=u[Number(e.location_id)]?.regionName;t&&n.add(l(t))}else"range"===t&&n.add(c(e[t]))}),Array.from(n).sort()},T=e=>{p(t=>({...t,[e]:null})),C(t=>({...t,[e]:{}}))},L=t.useMemo(()=>{if(!s||"all"===s.regionID)return n||[];const e=s.regionName;return(n||[]).filter(t=>{const n=u[Number(t.location_id)];return(n?.regionName||"Unknown")===e})},[n,s,u]),V=t.useMemo(()=>{if(!s||"all"===s.regionID)return i||[];const e=s.regionName;return(i||[]).filter(t=>{const n=u[Number(t.location_id)];return(n?.regionName||"Unknown")===e})},[i,s,u]),P=t.useMemo(()=>[{accessorKey:"volume_remain",header:"Quantity",size:96},{accessorKey:"price",header:"Price",cell:e=>r(e.getValue()),size:160},{accessorFn:e=>{const t=u[Number(e.location_id)]?.security;return null==t?null:t},id:"security",header:"Sec.",cell:t=>{const n=Number(t.row.original.location_id),i=u[n]?.security;return"number"==typeof i?e.jsx("span",{style:{color:o(i)},children:i.toFixed(1)}):e.jsx("span",{children:"—"})},size:78},{accessorFn:e=>{const t=Number(e.location_id);return u[t]?.isNPC??t<1e12?"NPC":"Player"},id:"station_type",header:"Type",cell:t=>{const n=t.getValue();return e.jsx("span",{style:{color:"NPC"===n?"#4CAF50":"#2196F3",fontWeight:"500"},children:n})},size:65},{accessorKey:"location_id",id:"location_name",header:"Location",cell:t=>{const n=Number(t.getValue()),i=l(u[n]?.name||"Unknown"),s=`${t.column.id}-${t.row.id}`,r=I.has(s);return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{cursor:"pointer"},onClick:()=>O(n,s),title:"Click to copy location name",children:i}),r&&e.jsx("span",{style:{fontSize:"0.8em",color:"#6dd36d"},children:"Copied"})]})},sortingFn:(e,t)=>{const n=e=>{const t=u[Number(e)];if(!t)return"zzz";return`${null===t.security||void 0===t.security?999:d(t.security)}-${(t.name||"").toLowerCase()}`},i=n(e.original.location_id),s=n(t.original.location_id);return i.localeCompare(s)},size:470},{accessorKey:"location_id",id:"region_name",header:"Region",cell:e=>{const t=u[Number(e.getValue())]?.regionName||"Unknown";return l(t)},sortingFn:(e,t)=>{const n=u[Number(e.original.location_id)]?.regionName||"",i=u[Number(t.original.location_id)]?.regionName||"";return n.localeCompare(i)},size:128},{accessorKey:"duration",header:"Expires in",cell:e=>{const t=e.row.original||{},n=t.expires_at||t.expiry||t.expiresAt||null;let i=null;if(n){const e=new Date(n);isNaN(e.getTime())||(i=e.getTime())}if(null==i){const{issued:e,duration:n}=t;if(e&&"number"==typeof n){const t=new Date(e);isNaN(t.getTime())||(i=t.getTime()+24*n*60*60*1e3)}}if(null==i&&"number"==typeof t.duration_seconds&&(i=Date.now()+1e3*t.duration_seconds),null==i)return"—";const s=i-Date.now();if(!Number.isFinite(s))return"—";const r=Math.max(Math.floor(s/6e4),0);return a(r)},size:112}],[u,I]),$=t.useMemo(()=>[{accessorKey:"min_volume",header:"Min Volume",cell:e=>(e.getValue()??0).toLocaleString(),size:80},{accessorKey:"volume_remain",header:"Quantity",size:96},{accessorKey:"price",header:"Price",cell:e=>r(e.getValue()),size:160},{accessorFn:e=>{const t=u[Number(e.location_id)]?.security;return null==t?null:t},id:"security",header:"Sec.",cell:t=>{const n=Number(t.row.original.location_id),i=u[n]?.security;return"number"==typeof i?e.jsx("span",{style:{color:o(i)},children:i.toFixed(1)}):e.jsx("span",{children:"—"})},size:78},{accessorFn:e=>{const t=Number(e.location_id);return u[t]?.isNPC??t<1e12?"NPC":"Player"},id:"station_type",header:"Type",cell:t=>{const n=t.getValue();return e.jsx("span",{style:{color:"NPC"===n?"#4CAF50":"#2196F3",fontWeight:"500"},children:n})},size:65},{accessorKey:"location_id",id:"location_name",header:"Location",cell:t=>{const n=Number(t.getValue()),i=l(u[n]?.name||"Unknown"),s=`${t.column.id}-${t.row.id}`,r=I.has(s);return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{cursor:"pointer"},onClick:()=>O(n,s),title:"Click to copy location name",children:i}),r&&e.jsx("span",{style:{fontSize:"0.8em",color:"#6dd36d"},children:"Copied"})]})},sortingFn:(e,t)=>{const n=e=>{const t=u[Number(e)];if(!t)return"zzz";return`${null===t.security||void 0===t.security?999:d(t.security)}-${(t.name||"").toLowerCase()}`},i=n(e.original.location_id),s=n(t.original.location_id);return i.localeCompare(s)},size:470},{accessorKey:"location_id",id:"region_name",header:"Region",cell:e=>{const t=u[e.getValue()]?.regionName||"Unknown";return l(t)},sortingFn:(e,t)=>{const n=u[Number(e.original.location_id)]?.regionName||"",i=u[Number(t.original.location_id)]?.regionName||"";return n.localeCompare(i)},size:128},{accessorKey:"range",header:"Range",cell:e=>c(e.getValue()),size:84},{accessorKey:"duration",header:"Expires in",cell:e=>{const t=e.row.original||{},n=t.expires_at||t.expiry||t.expiresAt||null;let i=null;if(n){const e=new Date(n);isNaN(e.getTime())||(i=e.getTime())}if(null==i){const{issued:e,duration:n}=t;if(e&&"number"==typeof n){const t=new Date(e);isNaN(t.getTime())||(i=t.getTime()+24*n*60*60*1e3)}}if(null==i&&"number"==typeof t.duration_seconds&&(i=Date.now()+1e3*t.duration_seconds),null==i)return"—";const s=i-Date.now();if(!Number.isFinite(s))return"—";const r=Math.max(Math.floor(s/6e4),0);return a(r)},size:112}],[u,I]),U=(e,t,n,i,s)=>{const r=(e,t)=>{_(n=>({...n,[t]:"function"==typeof e?e(n[t]):e}))};return y({data:e,columns:t,defaultColumn:{minSize:60,maxSize:600,size:void 0,enableResizing:!0,enableColumnFilter:!0,filterFn:A},columnResizeMode:"onChange",getCoreRowModel:w(),getSortedRowModel:S(),getFilteredRowModel:v(),getExpandedRowModel:x(),state:{sorting:M[n],columnSizing:M[i],columnFilters:M[s]},enableSortingRemoval:!1,onSortingChange:e=>r(e,n),onColumnSizingChange:e=>r(e,i),onColumnFiltersChange:e=>r(e,s),getRowId:e=>{const t=e.order_id??`${e.is_buy_order?"B":"S"}-${e.type_id}-${e.region_id??"r"}-${e.location_id??"l"}-${e.price}`;return String(t)}})},W=U(L,P,"sellerSorting","sellerSizing","sellerColumnFilters"),K=U(V,$,"buyerSorting","buyerSizing","buyerColumnFilters"),H=e=>{if(!e||0===e.length)return null;const t=e.reduce((e,t)=>e+(t.volume_remain??0),0),n=e.reduce((e,t)=>e+(t.price??0)*(t.volume_remain??0),0);return t>0?n/t:null},Q=t.useMemo(()=>H(L),[L]),J=t.useMemo(()=>H(V),[V]);ue({count:W.getRowModel().rows.length,getScrollElement:()=>D.current,estimateSize:()=>24,overscan:5,initialOffset:0,getItemKey:e=>W.getRowModel().rows[e]?.id??e}),ue({count:K.getRowModel().rows.length,getScrollElement:()=>R.current,estimateSize:()=>24,overscan:5,initialOffset:0,getItemKey:e=>K.getRowModel().rows[e]?.id??e});const G=(t,n)=>{const i="seller"===t?W:K;if(f[t]!==n)return null;const s="seller"===t?L:V;return e.jsxs("div",{className:"filter-panel-enhanced",ref:z,children:[e.jsx("div",{className:"filter-search-section",children:e.jsx("input",{type:"text",placeholder:"Search...",className:"filter-search-input",value:j[t]?.[n]||"",onChange:e=>{const i=e.target.value;N(e=>({...e,[t]:{...e[t],[n]:i}}))}})}),e.jsx("div",{className:"filter-options-list",children:(()=>{const i=F(s,n),r=k[t]?.[n],o=j[t]?.[n]||"",l=i.filter(e=>!o||e.toLowerCase().includes(o.toLowerCase()));return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"filter-select-all-option",children:[e.jsx("input",{type:"checkbox",checked:r?.selectAll||!1,onChange:e=>{const s=e.target.checked;C(e=>({...e,[t]:{...e[t],[n]:{selectAll:s,selectedValues:s?new Set(i):new Set}}}))}}),"(Select All)"]}),l.map(s=>{const o=r?.selectedValues?.has(s)||!1;return e.jsxs("label",{className:"filter-option",children:[e.jsx("input",{type:"checkbox",checked:o,onChange:e=>{const o=new Set(r?.selectedValues||[]);e.target.checked?o.add(s):o.delete(s);const l=o.size===i.length;C(e=>({...e,[t]:{...e[t],[n]:{selectAll:l,selectedValues:o}}}))}}),s]},s)})]})})()}),e.jsxs("div",{className:"filter-actions",children:[e.jsxs("button",{className:"filter-cancel-btn",onClick:()=>T(t),children:[e.jsx(X,{})," Cancel"]}),e.jsxs("button",{className:"filter-ok-btn",onClick:()=>((e,t,n)=>{const i=k[e]?.[t];if(!i)return;const s=F("seller"===e?L:V,t),r=Array.from(i.selectedValues),o=r.length===s.length?[]:r;n.getColumn(t).setFilterValue(o),p(t=>({...t,[e]:null})),C(n=>({...n,[e]:{...n[e],[t]:void 0}}))})(t,n,i),children:[e.jsx(q,{})," OK"]})]})]})},Y=(t,n,i)=>({column:s})=>{const r=["security","station_type","region_name","location_name"].includes(s.id)||"buyer"===n&&"range"===s.id,o=f[n]===s.id;return e.jsxs("div",{className:"header-with-filter",children:[e.jsxs("span",{className:"header-text",onClick:()=>{const e=s.getIsSorted();e?"asc"===e?s.toggleSorting(!0):s.clearSorting():s.toggleSorting(!1)},style:{cursor:"pointer"},children:[t,"asc"===s.getIsSorted()?" ▲":"desc"===s.getIsSorted()?" ▼":""]}),r&&e.jsx("button",{className:"filter-button",onClick:e=>{e.stopPropagation(),o?T(n):((e,t,n)=>{const i=n.getColumn(t).getFilterValue()||[],s=F("seller"===e?L:V,t),r=0===i.length;C(n=>({...n,[e]:{...n[e],[t]:{selectAll:r,selectedValues:r?new Set(s):new Set(i)}}})),p(n=>({...n,[e]:t}))})(n,s.id,i)},title:"Filter column",children:e.jsx(B,{})})]})},Z=(t,n,i,s,r)=>e.jsxs("div",{className:"market-table-wrapper",children:[e.jsxs("h3",{className:"market-table-title",children:[t," (",n.getRowModel().rows.length," orders)","seller"===r&&null!==Q&&e.jsxs("span",{style:{marginLeft:"1rem",fontWeight:"normal",fontSize:"0.95em",color:"#ccc"},children:["Avg Price: ",Q.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ISK"]}),"buyer"===r&&null!==J&&e.jsxs("span",{style:{marginLeft:"1rem",fontWeight:"normal",fontSize:"0.95em",color:"#ccc"},children:["Avg Price: ",J.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ISK"]})]}),e.jsxs("div",{className:"market-table",children:[e.jsx("div",{className:"thead",children:n.getHeaderGroups().map(t=>e.jsx("div",{className:"thead-row",children:t.headers.map(t=>e.jsxs("div",{className:"column-header-wrapper",children:[e.jsxs("div",{className:"column-header",style:{width:t.getSize()},children:[t.column.columnDef.Header?b(t.column.columnDef.Header,t.getContext()):Y(t.column.columnDef.header,r,n)(t.getContext()),t.column.getCanResize()&&e.jsx("div",{onMouseDown:t.getResizeHandler(),onTouchStart:t.getResizeHandler(),className:"resizer "+(t.column.getIsResizing()?"isResizing":"")})]}),G(r,t.column.id)]},t.id))},t.id))}),e.jsx("div",{ref:i,className:"table-body",children:e.jsx("div",{style:{height:s.getTotalSize(),position:"relative"},children:s.getVirtualItems().map(t=>{const i=n.getRowModel().rows[t.index];return e.jsx("div",{className:"table-row",style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${t.start}px)`},children:i.getVisibleCells().map(t=>e.jsx("div",{className:"table-cell",style:{width:t.column.getSize(),whiteSpace:"nowrap"},children:b(t.column.columnDef.cell,t.getContext())},t.id))},i.id)})})})]})]}),ee=t.useMemo(()=>P.map(e=>({...e,Header:(["security","region_name","location_name","range"].includes(e.id),Y(e.header,"seller",W))})),[P,W]),te=t.useMemo(()=>$.map(e=>({...e,Header:(["security","region_name","location_name","range"].includes(e.id),Y(e.header,"buyer",K))})),[$,K,V]),ne=y({data:L,columns:ee,defaultColumn:{minSize:60,maxSize:600,size:void 0,enableResizing:!0,enableColumnFilter:!0,filterFn:A},columnResizeMode:"onChange",getCoreRowModel:w(),getSortedRowModel:S(),getFilteredRowModel:v(),getExpandedRowModel:x(),state:{sorting:M.sellerSorting,columnSizing:M.sellerSizing,columnFilters:M.sellerColumnFilters},enableSortingRemoval:!1,onSortingChange:e=>_(t=>({...t,sellerSorting:"function"==typeof e?e(t.sellerSorting):e})),onColumnSizingChange:e=>_(t=>({...t,sellerSizing:"function"==typeof e?e(t.sellerSizing):e})),onColumnFiltersChange:e=>_(t=>({...t,sellerColumnFilters:"function"==typeof e?e(t.sellerColumnFilters):e})),getRowId:e=>{const t=e.order_id??`${e.is_buy_order?"B":"S"}-${e.type_id}-${e.region_id??"r"}-${e.location_id??"l"}-${e.price}`;return String(t)}}),ie=y({data:V,columns:te,defaultColumn:{minSize:60,maxSize:600,size:void 0,enableResizing:!0,enableColumnFilter:!0,filterFn:A},columnResizeMode:"onChange",getCoreRowModel:w(),getSortedRowModel:S(),getFilteredRowModel:v(),getExpandedRowModel:x(),state:{sorting:M.buyerSorting,columnSizing:M.buyerSizing,columnFilters:M.buyerColumnFilters},enableSortingRemoval:!1,onSortingChange:e=>_(t=>({...t,buyerSorting:"function"==typeof e?e(t.buyerSorting):e})),onColumnSizingChange:e=>_(t=>({...t,buyerSizing:"function"==typeof e?e(t.buyerSizing):e})),onColumnFiltersChange:e=>_(t=>({...t,buyerColumnFilters:"function"==typeof e?e(t.buyerColumnFilters):e})),getRowId:e=>{const t=e.order_id??`${e.is_buy_order?"B":"S"}-${e.type_id}-${e.region_id??"r"}-${e.location_id??"l"}-${e.price}`;return String(t)}}),se=ue({count:ne.getRowModel().rows.length,getScrollElement:()=>D.current,estimateSize:()=>24,overscan:5,initialOffset:0,getItemKey:e=>ne.getRowModel().rows[e]?.id??e}),re=ue({count:ie.getRowModel().rows.length,getScrollElement:()=>R.current,estimateSize:()=>24,overscan:5,initialOffset:0,getItemKey:e=>ie.getRowModel().rows[e]?.id??e});return e.jsxs(e.Fragment,{children:[Z("Sellers",ne,D,se,"seller"),Z("Buyers",ie,R,re,"buyer")]})}function he({orders:n=[],regions:i=[],onRegionClick:s,selectedRegion:r}){if("all"!==r?.regionID)return e.jsxs("div",{style:{width:"100%",height:400,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",background:"#1a1a1a",color:"#fff",border:"1px solid #333"},children:[e.jsx("p",{children:'Market distribution chart is only available when "All Regions" is selected.'}),e.jsxs("p",{style:{marginTop:"10px",fontSize:"0.9em",opacity:.7},children:["Current selection: ",r?.regionName||"None"]}),e.jsx("p",{style:{marginTop:"10px",fontSize:"0.9em",opacity:.7},children:'Select "All Regions" from the region dropdown to view market distribution across regions.'})]});const o=t.useMemo(()=>{if(!n||0===n.length)return[];const e=n.map(e=>e.price).filter(e=>e>0&&!isNaN(e));if(0===e.length)return[];e.sort((e,t)=>e-t);const t=Math.floor(.01*e.length),i=Math.floor(.99*e.length),s=Math.max(0,t),r=Math.min(e.length-1,i),o=e[s],l=e[r];return n.filter(e=>{const t=e.price,n=e.volume_remain,i=t>=o&&t<=l,s=n>0,r=e.regionName&&"Unknown"!==e.regionName;return i&&s&&r})},[n]),l=t.useMemo(()=>{if(!i||0===i.length)return[];const e={};i.forEach(t=>{const n=t.regionName||t.name;n&&(e[n]={region:n,buyerVolume:0,sellerVolume:0,buyerCount:0,sellerCount:0})}),o.forEach(t=>{const n=t.regionName;e[n]||(e[n]={region:n,buyerVolume:0,sellerVolume:0,buyerCount:0,sellerCount:0});const i=e[n];t.is_buy_order?(i.buyerVolume+=t.volume_remain||0,i.buyerCount+=1):(i.sellerVolume+=t.volume_remain||0,i.sellerCount+=1)});return Object.values(e).sort((e,t)=>e.region.localeCompare(t.region))},[o,i]);t.useEffect(()=>{l.length,n.length>0&&o.length,o.length>0&&l.length},[l,n,o,i]);const a=({active:t,payload:n,label:i})=>t&&n&&n.length?e.jsxs("div",{style:{backgroundColor:"#2a2a2a",border:"1px solid #444",borderRadius:"4px",padding:"10px",color:"#fff"},children:[e.jsx("p",{style:{margin:"0 0 5px 0",fontWeight:"bold"},children:i}),n.map((t,n)=>e.jsxs("p",{style:{margin:"2px 0",color:t.color,fontSize:"12px"},children:[t.name,": ",t.value?.toLocaleString()||0]},n))]}):null;return l&&0!==l.length?e.jsxs("div",{style:{width:"100%",height:400,background:"#1a1a1a",border:"1px solid #333",padding:"10px"},children:[e.jsxs("div",{style:{color:"#fff",marginBottom:"10px",fontSize:"12px"},children:["Showing data for ",l.length," regions with market activity"]}),e.jsx(j,{width:"100%",height:"90%",children:e.jsxs(N,{data:l,margin:{top:20,right:50,left:50,bottom:80},children:[e.jsx(k,{dataKey:"region",angle:-45,textAnchor:"end",interval:0,height:100,fontSize:10,stroke:"#ccc"}),e.jsx(C,{yAxisId:"left",orientation:"left",stroke:"#2ca02c",fontSize:10,label:{value:"Seller Volume (Supply)",angle:-90,position:"insideLeft",style:{textAnchor:"middle"}}}),e.jsx(C,{yAxisId:"right",orientation:"right",stroke:"#ff7f0e",fontSize:10,label:{value:"Buyer Volume (Demand)",angle:90,position:"insideRight",style:{textAnchor:"middle"}}}),e.jsx(I,{content:e.jsx(a,{})}),e.jsx(E,{payload:[{value:"Seller Volume (Supply)",type:"rect",color:"#2ca02c",id:"sellerVolume"},{value:"Buyer Volume (Demand)",type:"line",color:"#ff7f0e",id:"buyerVolume"}],verticalAlign:"top",height:36,wrapperStyle:{color:"#fff",fontSize:"12px"}}),e.jsx(z,{yAxisId:"left",dataKey:"sellerVolume",fill:"#2ca02c",name:"Seller Volume (Supply)",onClick:e=>{s&&e?.region&&s(e.region)},cursor:"pointer"}),e.jsx(M,{yAxisId:"right",type:"monotone",dataKey:"buyerVolume",stroke:"#ff7f0e",strokeWidth:2,name:"Buyer Volume (Demand)",dot:{r:3,fill:"#ff7f0e"},activeDot:{r:5,fill:"#ff7f0e"}})]})})]}):e.jsxs("div",{style:{width:"100%",height:400,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",background:"#1a1a1a",color:"#fff",border:"1px solid #333"},children:[e.jsx("h3",{children:"No Market Data Available"}),e.jsxs("div",{style:{textAlign:"left",fontSize:"12px",opacity:.7,marginTop:"20px"},children:[e.jsx("p",{children:"Debug Info:"}),e.jsxs("p",{children:["• Raw orders: ",n?.length||0]}),e.jsxs("p",{children:["• Filtered orders: ",o.length]}),e.jsxs("p",{children:["• Regions: ",i?.length||0]}),e.jsxs("p",{children:["• Chart data points: ",l.length]}),o.length>0&&e.jsxs("p",{children:["• Sample order region: ",o[0]?.regionName||"Unknown"]})]})]})}function ge({selectedItem:n,selectedRegion:i,setActiveTab:s}){const[r,o]=t.useState([]),[l,a]=t.useState([]),[c,d]=t.useState(0),[u,m]=t.useState(30),[h,g]=t.useState(!1),[f,p]=t.useState(null),[y,b]=t.useState("day"),x=t.useRef(null),v=t.useRef(null),S=t.useRef({type:null,startX:0,initialStartIndex:0,initialEndIndex:0});function w(e,t){if(!Array.isArray(e)||!e.length||"day"===t)return e;const n=new Map;for(const i of e){if(!i||!i.date)continue;const e=new Date(i.date+"T00:00:00Z");if(isNaN(e))continue;let s;if("month"===t)s=`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}`;else if("week"===t){const t=e.getUTCDay(),n=0===t?-6:1-t;s=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()+n)).toISOString().slice(0,10)}else s=i.date;n.has(s)||n.set(s,{date:s,totalVolume:0,_totalValue:0,highest:0,lowest:Number.POSITIVE_INFINITY,order_count:0});const r=n.get(s),o=Number(i.totalVolume||i.volume||0)||0,l=Number(i.average||0)||0;r.totalVolume+=o,r._totalValue+=o*l,r.highest=Math.max(r.highest,Number(i.highest||l||0));const a=Number(i.lowest||l||0);a>0&&(r.lowest=Math.min(r.lowest,a)),r.order_count+=Number(i.order_count||0)||0}return Array.from(n.values()).map(e=>({date:e.date,average:e.totalVolume>0?e._totalValue/e.totalVolume:0,totalVolume:e.totalVolume,highest:e.highest,lowest:e.lowest===Number.POSITIVE_INFINITY?0:e.lowest,order_count:e.order_count})).sort((e,t)=>new Date(e.date)-new Date(t.date))}function O(e,t){e.preventDefault(),e.stopPropagation(),S.current={type:t,startX:e.clientX,initialStartIndex:c,initialEndIndex:u},document.body.style.cursor="move"===t?"grabbing":"ew-resize",window.addEventListener("mousemove",F),window.addEventListener("mouseup",T)}function F(e){if(!S.current.type||!x.current||0===l.length)return;const t=e.clientX-S.current.startX,n=x.current.offsetWidth,i=Math.round(t/n*l.length);let s=S.current.initialStartIndex,r=S.current.initialEndIndex;if("move"===S.current.type){const e=r-s;s=Math.max(0,Math.min(l.length-e,s+i)),r=s+e}else"resize-left"===S.current.type?(s=Math.max(0,Math.min(r-1,s+i)),r-s>365&&(s=r-365)):"resize-right"===S.current.type&&(r=Math.min(l.length,Math.max(s+1,r+i)),r-s>365&&(r=s+365));d(s),m(r)}function T(){document.body.style.cursor="",window.removeEventListener("mousemove",F),window.removeEventListener("mouseup",T),S.current={type:null,startX:0,initialStartIndex:0,initialEndIndex:0}}if(t.useEffect(()=>{if(!n)return a([]),void p("No item selected");let e=!1;return g(!0),p(null),async function(){try{let s;if(s=!i||"all"===i.regionID?await R(n.typeID):await A(n.typeID,i.regionID),e)return;o(s||[]),a(w(s||[],y));const r=s?.length||0,l="week"===(t=y)?1:"month"===t?3:30,c=Math.min(l,r||0),u=Math.max(0,r-c),h=r;d(u),m(h)}catch(s){if(e)return;p(s.message||"Failed to load market history")}finally{e||g(!1)}var t}(),()=>{e=!0}},[n,i,y]),t.useEffect(()=>{if(r.length){const e=w(r,y);a(e);const t=e.length,n="week"===y?1:"month"===y?3:30,i=Math.min(n,t||0),s=Math.max(0,t-i),o=t;d(s),m(o)}},[y]),h)return e.jsx("div",{style:{width:"100%",height:500,display:"flex",alignItems:"center",justifyContent:"center",background:"#1a1a1a",color:"#fff",border:"1px solid #333"},children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{children:"Loading universe market history..."}),e.jsxs("div",{style:{fontSize:"12px",opacity:.7,marginTop:"10px"},children:["Item: ",n?.typeName||"Unknown"]})]})});if(f)return e.jsx("div",{style:{width:"100%",height:500,display:"flex",alignItems:"center",justifyContent:"center",background:"#1a1a1a",color:"#fff",border:"1px solid #333"},children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{color:"#ff6b6b"},children:"Error loading universe market history"}),e.jsx("div",{style:{fontSize:"12px",opacity:.7,marginTop:"10px"},children:f}),e.jsxs("div",{style:{fontSize:"12px",opacity:.5,marginTop:"10px"},children:["Debug: Item=",n?.typeName]})]})});if(!l.length)return e.jsx("div",{style:{width:"100%",height:500,display:"flex",alignItems:"center",justifyContent:"center",background:"#1a1a1a",color:"#fff",border:"1px solid #333"},children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{children:"No market history available"}),e.jsx("div",{style:{fontSize:"12px",opacity:.7,marginTop:"10px"},children:"This could be due to:"}),e.jsxs("ul",{style:{fontSize:"12px",opacity:.7,textAlign:"left",marginTop:"5px"},children:[e.jsx("li",{children:"Item not actively traded"}),e.jsx("li",{children:"API service unavailable"}),e.jsx("li",{children:"Network connectivity issues"}),e.jsx("li",{children:"Invalid item data"})]}),e.jsxs("div",{style:{fontSize:"12px",opacity:.5,marginTop:"10px"},children:["Debug: Item=",n?.typeName]})]})});const L=Math.max(0,Math.min(c,l.length-1)),V=Math.max(L+1,Math.min(u,l.length)),P=l.slice(L,V),$=!i||"all"===i.regionID?"All Regions (Universe)":i.regionName,U=({active:t,payload:n,label:i})=>t&&n&&n.length?e.jsxs("div",{style:{backgroundColor:"#2a2a2a",border:"1px solid #444",borderRadius:"4px",padding:"10px",color:"#fff"},children:[e.jsx("p",{style:{margin:"0 0 5px 0",fontWeight:"bold"},children:i}),n.map((t,n)=>e.jsxs("p",{style:{margin:"2px 0",color:t.color,fontSize:"12px"},children:[t.name,": ",t.value?.toLocaleString()||"N/A"]},n))]}):null;return e.jsxs("div",{style:{width:"100%",height:500,background:"#1a1a1a",border:"1px solid #333",padding:"10px"},children:[e.jsxs("div",{style:{display:"flex",gap:16,marginBottom:8,alignItems:"center",color:"#ccc",fontSize:12},children:[e.jsx("span",{style:{fontWeight:600},children:"Interval:"}),["day","week","month"].map(t=>e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:4,cursor:"pointer"},children:[e.jsx("input",{type:"radio",name:"granularity",value:t,checked:y===t,onChange:()=>b(t),style:{cursor:"pointer"}}),t.charAt(0).toUpperCase()+t.slice(1)]},t)),e.jsx("span",{style:{opacity:.6},children:"day"===y?"Daily data":"week"===y?"Monday-based weeks":"Calendar months"})]}),e.jsxs("div",{style:{color:"#fff",marginBottom:"10px",fontSize:"12px"},children:["Market History: ",n?.typeName," - ",$," | Showing ",P.length," of ",l.length," ",y,1===l.length?"":"s"," | Range: ",L,"-",V,l.length<7&&l.length>0&&e.jsxs("span",{style:{color:"#ffa500",marginLeft:"10px"},children:["⚠️ Limited market data available (",l.length," ",y,1===l.length?"":"s",")"]}),0===l.length&&e.jsx("span",{style:{color:"#ff6b6b",marginLeft:"10px"},children:"❌ No market history data available"})]}),e.jsx(j,{width:"100%",height:380,children:e.jsxs(N,{data:P,margin:{top:20,right:50,left:50,bottom:50},children:[e.jsx(_,{strokeDasharray:"3 3",stroke:"#444"}),e.jsx(k,{dataKey:"date",angle:-45,textAnchor:"end",interval:Math.max(0,Math.floor(P.length/10)),stroke:"#ccc",fontSize:10}),e.jsx(C,{yAxisId:"left",label:{value:"Avg Price (ISK)",angle:-90,position:"insideLeft",style:{textAnchor:"middle"}},tickFormatter:e=>e?e.toLocaleString():"",domain:["auto","auto"],stroke:"#1f77b4",fontSize:10}),e.jsx(C,{yAxisId:"right",orientation:"right",label:{value:"Volume",angle:90,position:"insideRight",style:{textAnchor:"middle"}},tickFormatter:e=>e?e.toLocaleString():"",domain:[0,"auto"],stroke:"#8884d8",fontSize:10}),e.jsx(I,{content:e.jsx(U,{})}),e.jsx(E,{verticalAlign:"top",height:36,wrapperStyle:{color:"#fff",fontSize:"12px"}}),e.jsx(M,{yAxisId:"left",type:"monotone",dataKey:"average",stroke:"#1f77b4",strokeWidth:2,dot:!1,name:"Average Price"}),e.jsx(z,{yAxisId:"right",dataKey:"totalVolume",fill:"#8884d8",barSize:Math.max(1,Math.min(20,300/P.length)),opacity:.4,name:"Volume"})]})}),e.jsxs("div",{ref:x,style:{position:"relative",height:60,marginTop:10,background:"#555",border:"1px solid #666",overflow:"hidden",userSelect:"none"},children:[e.jsx("div",{style:{position:"absolute",inset:0,zIndex:1},children:e.jsx(j,{width:"100%",height:"100%",children:e.jsx(N,{data:l,children:e.jsx(D,{type:"monotone",dataKey:"totalVolume",stroke:"#8884d8",fill:"#8884d8",opacity:.3})})})}),e.jsxs("div",{ref:v,style:{position:"absolute",top:0,left:L/l.length*100+"%",width:(V-L)/l.length*100+"%",height:"100%",background:"rgba(100, 149, 237, 0.3)",border:"2px solid #6495ED",borderRadius:4,boxShadow:"0 0 4px rgba(0,0,0,0.2)",display:"flex",justifyContent:"space-between",alignItems:"center",cursor:"move"===S.current.type?"grabbing":"grab",zIndex:2,transition:S.current.type?"none":"all 0.1s ease"},onMouseDown:e=>O(e,"move"),children:[e.jsxs("div",{style:{position:"absolute",top:4,right:8,background:"rgba(0,0,0,0.8)",color:"#fff",padding:"2px 6px",borderRadius:4,fontSize:12,pointerEvents:"none"},children:[V-L,"day"===y?"d":"week"===y?"w":"m"]}),e.jsx("div",{style:{width:8,height:"100%",cursor:"ew-resize",background:"#6495ED",borderRadius:"4px 0 0 4px",transition:"background-color 0.2s ease"},onMouseDown:e=>O(e,"resize-left"),onMouseEnter:e=>e.target.style.backgroundColor="#4169E1",onMouseLeave:e=>e.target.style.backgroundColor="#6495ED"}),e.jsx("div",{style:{width:8,height:"100%",cursor:"ew-resize",background:"#6495ED",borderRadius:"0 4px 4px 0",transition:"background-color 0.2s ease"},onMouseDown:e=>O(e,"resize-right"),onMouseEnter:e=>e.target.style.backgroundColor="#4169E1",onMouseLeave:e=>e.target.style.backgroundColor="#6495ED"})]})]})]})}function fe({regionsData:n,filterOutliers:i}){const s=t.useRef(null),[r,o]=t.useState(null);return t.useEffect(()=>{n&&async function(e,t=!0){try{const e=44992,i=19000001;let s=[];try{const t=await O(e,i);s=[...t.sellOrders||[],...t.buyOrders||[]]}catch(n){return{name:"PLEX",highestBuy:null,lowestSell:null,averageSell:null}}const r=s.filter(e=>!e.is_buy_order),o=s.filter(e=>e.is_buy_order),l=u(r,t),a=u(o,t),c=(e=>{if(!e||0===e.length)return null;const t=e.reduce((e,t)=>e+t.volume_remain,0),n=e.reduce((e,t)=>e+t.price*t.volume_remain,0);return t>0?n/t:null})(l);return{name:"PLEX",highestBuy:a.length>0?Math.max(...a.map(e=>e.price)):null,lowestSell:l.length>0?Math.min(...l.map(e=>e.price)):null,averageSell:c}}catch(n){throw n}}(0,i).then(e=>{o(e)}).catch(e=>{})},[n,i]),t.useEffect(()=>{if(!r||!s.current)return;const e=s.current;e.innerHTML="";const t=document.createElement("div");t.className="marquee__item";const n=[{label:"Highest Buy",value:r.highestBuy,className:"highest"},{label:"Lowest Sell",value:r.lowestSell,className:"lowest"},{label:"Average Sell",value:r.averageSell,className:"average"}].filter(e=>null!==e.value);if(n.forEach(({label:e,value:n,className:i})=>{const s=document.createElement("span");s.className=`marquee__text ${i}`,s.textContent=`PLEX — ${e}: ${(e=>`${e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})} ISK`)(n)} • `,t.appendChild(s)}),0===n.length){const e=document.createElement("span");e.className="marquee__text",e.textContent="PLEX — Loading market data... • ",t.appendChild(e)}e.appendChild(t),e.offsetWidth;const i=t.offsetWidth,o=e.parentElement.offsetWidth,l=Math.ceil(o/i*2)+2;for(let s=1;s<l;s++)e.appendChild(t.cloneNode(!0));const a=`marquee-scroll-${Date.now()}`,c=`\n            @keyframes ${a} {\n                0% { transform: translateX(0); }\n                100% { transform: translateX(-${i}px); }\n            }\n        `,d=document.createElement("style");return d.id="marquee-keyframes",d.textContent=c,document.head.appendChild(d),e.style.animation=`${a} ${i/60}s linear infinite`,()=>{document.querySelector("#marquee-keyframes")?.remove()}},[r]),e.jsx("div",{id:"plexTicker",className:"marquee",children:e.jsx("div",{ref:s,className:"marquee__content"})})}function pe(){const[n,s]=t.useState(null),[r,o]=t.useState(null),[l,a]=t.useState({regionID:"all",regionName:"All Regions"}),[c,d]=t.useState("orders"),[p,y]=t.useState(null),[b,x]=t.useState([]),[v,S]=t.useState([]),[w,j]=t.useState("none"),[N,k]=t.useState([]),[C,I]=t.useState([]),[E,z]=t.useState([]),[M,_]=t.useState({}),D=i(),R=new URLSearchParams(D.search),A=parseInt(R.get("item")||"0",10),[F]=t.useState(A||0),[T,L]=t.useState(null);t.useEffect(()=>{fetch("/EVE-Data-Site/data/market.json").then(e=>{if(!e.ok)throw new Error("Failed to load market.json");return e.json()}).then(e=>{let t=e;t&&!Array.isArray(t)&&"object"==typeof t&&(t=Object.entries(t).map(([e,t])=>({...t,name:e}))),Array.isArray(t)&&0!==t.length?(L(null),s(t)):(L("Market tree data is empty or invalid."),s(null))}).catch(()=>{L("Failed to load market tree."),s(null)})},[]);const V=t.useMemo(()=>n?m(n):{items:[],pathMap:{}},[n]);t.useEffect(()=>{h().then(k).catch(e=>{})},[]),t.useEffect(()=>{if(!N.length)return;(async()=>{const e=new Map;N.forEach(t=>e.set(Number(t.regionID),t.regionName));const t={};try{const n=await f();let i=[];Array.isArray(n)?i=n:n&&"object"==typeof n&&(i=Object.entries(n).map(([e,t])=>({station_id:Number(e),...t}))),z(i),i.forEach(n=>{const i=Number(n.station_id??n.stationID);if(!Number.isFinite(i))return;const s=n.name||n.stationName||n.locationName||"Unknown",r=n.region_name||n.regionName||e.get(Number(n.region_id??n.regionID))||"Unknown",o="number"==typeof n.security_status?n.security_status:"number"==typeof n.security?n.security:"number"==typeof n.securityStatus?n.securityStatus:null;t[i]={name:s,security:o,regionName:r,type:"station",isNPC:!0}})}catch(n){}C.forEach(n=>{const i=Number(n.structureID??n.stationID);Number.isFinite(i)&&(t[i]={name:n.locationName||n.name||"Unknown",security:"number"==typeof n.security?n.security:null,regionName:n.regionName||e.get(Number(n.regionID))||"Unknown",type:"structure",isNPC:!1})}),_(t)})()},[N,C]),t.useEffect(()=>{g().then(I).catch(e=>{})},[]);const[P,$]=t.useState(!1);t.useEffect(()=>{if(P)return;if(!n||!V?.items?.length)return;if(!A)return void $(!0);let e=V.items.find(e=>Number(e.typeID)===A);if(e||(e=U(A,n)),e){o(e);const t=V.pathMap[e.typeID]||V.pathMap[A]||[];y(t),d("orders"),setTimeout(()=>{window.marketTreeNavigate&&Array.isArray(t)&&t.length&&window.marketTreeNavigate(t)},150)}$(!0)},[n,V,A,P]),t.useEffect(()=>{if(!P)return;const e=new URLSearchParams(window.location.search);if(e.has("item")){if(r&&F&&r.typeID===F)return;e.delete("item");const t=`${window.location.pathname}${e.toString()?"?"+e.toString():""}`;window.history.replaceState({},"",t)}},[r,P,F]);const U=(e,t)=>{const n=Number(e),i=e=>{if(!e||"object"!=typeof e)return null;if(Array.isArray(e.items)){const t=e.items.find(e=>Number(e.typeID)===n);if(t)return t}for(const[t,n]of Object.entries(e))if("_info"!==t&&"items"!==t&&n&&"object"==typeof n&&!Array.isArray(n)){const e=i(n);if(e)return e}return null};if(Array.isArray(t))for(const s of t){const e=i(s);if(e)return e}else for(const[,s]of Object.entries(t))if(s&&"object"==typeof s){const e=i(s);if(e)return e}return null},W=t.useCallback(async()=>{if(r&&N.length)try{let e=[];const t=l?.regionID,n=44992,i=19000001;if(r.typeID===n){const t=await O(r.typeID,i);e=[...t.sellOrders||[],...t.buyOrders||[]].map(e=>({...e,region_id:i}))}else if(t&&"all"!==t){const n=await O(r.typeID,t);e=[...n.sellOrders||[],...n.buyOrders||[]].map(e=>({...e,region_id:e.region_id||t}))}else{const t=N.map(async e=>{try{const t=await O(r.typeID,e.regionID);return[...t.sellOrders||[],...t.buyOrders||[]].map(t=>({...t,region_id:e.regionID}))}catch{return[]}});e=(await Promise.all(t)).flat()}const s=u(e.filter(e=>!e.is_buy_order),w),o=u(e.filter(e=>e.is_buy_order),w);x(s),S(o)}catch(e){}},[r,l,N,w]);t.useEffect(()=>{W()},[W]),t.useEffect(()=>{const e=[...b,...v];if(0===e.length)return;const t={...M},n=new Map(N.map(e=>[Number(e.regionID),e.regionName]));let i=0;e.forEach(e=>{const s=Number(e.location_id);if(Number.isFinite(s)&&!(s<=0)&&!t[s]){const r=E.find(e=>Number(e.station_id??e.stationID)===s);if(r){const e=r.name||r.stationName||r.locationName||"Unknown",o=r.region_name||r.regionName||n.get(Number(r.region_id??r.regionID))||"Unknown",l="number"==typeof r.security_status?r.security_status:"number"==typeof r.security?r.security:"number"==typeof r.securityStatus?r.securityStatus:null;return t[s]={name:e,regionName:o,security:l,type:"station",isNPC:!0},void i++}const o=C.find(e=>Number(e.structureID??e.stationID)===s);if(o){const e=o.locationName||o.name||"Unknown",r=o.regionName||n.get(Number(o.regionID))||"Unknown",l="number"==typeof o.security?o.security:null;return t[s]={name:e,regionName:r,security:l,type:"structure",isNPC:!1},void i++}const l=e.name||e.location_name,a=e.region_name||e.regionName||n.get(Number(e.region_id))||"Unknown Region";t[s]={name:l||"Unknown Location",regionName:a,security:"number"==typeof e.security?e.security:"number"==typeof e.security_status?e.security_status:null,type:e.location_type||e.type||"unknown",isNPC:(1===e.is_npc||!0===e.isNPC)??s<1e12},i++}}),i>0&&_(t)},[b,v]);const q=t.useMemo(()=>{const e=[...b,...v],t=new Map(N.map(e=>[Number(e.regionID),e.regionName]));return e.map(e=>({...e,regionName:t.get(Number(e.region_id))||`Region ${e.region_id||"Unknown"}`}))},[b,v,N]);t.useEffect(()=>{const e=()=>{const e=new URLSearchParams(window.location.search).get("item");if(e&&n){const t=U(e,n);t&&o(t)}};return window.addEventListener("popstate",e),()=>window.removeEventListener("popstate",e)},[n]);return e.jsxs("div",{className:"market",children:[T&&e.jsx("div",{style:{color:"red",padding:"1rem"},children:T}),e.jsxs("div",{className:"market-body",children:[e.jsx("div",{className:"left-panel",children:e.jsx(K,{selectedRegion:l,onRegionChange:a,regions:N,onItemSelect:e=>{if(o(e),F&&e?.typeID===F){const e=new URLSearchParams(window.location.search);if(!e.has("item")){e.set("item",String(F));const t=`${window.location.pathname}?${e.toString()}`;window.history.replaceState({},"",t)}}else if(window.location.search){const e=new URL(window.location.href),t=new URLSearchParams(e.search);t.has("item")&&(t.delete("item"),e.search=t.toString(),window.history.replaceState({},"",e.toString()))}d("orders")},marketTree:n,breadcrumbPath:p})}),e.jsx("div",{className:"right-panel",children:r&&!T&&e.jsxs(e.Fragment,{children:[e.jsx(Q,{selectedItem:r,marketTree:n,onBreadcrumbClick:e=>{y(e),setTimeout(()=>{const t=e.join("/"),n=document.querySelector(`[data-path="${t}"]`);n&&n.scrollIntoView({behavior:"smooth",block:"center"})},100)}}),e.jsxs("div",{className:"market-tabs-container",style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{className:"market-tabs",children:[e.jsx("button",{className:"orders"===c?"active":"",onClick:()=>d("orders"),children:"Market Orders"}),e.jsx("button",{className:"history"===c?"active":"",onClick:()=>d("history"),children:"Market History"}),e.jsx("button",{className:"distribution"===c?"active":"",onClick:()=>d("distribution"),children:"Market Distribution"}),e.jsxs("div",{style:{marginLeft:"1rem",display:"inline-flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{children:"Outlier Filter: "}),e.jsxs("select",{value:w,onChange:e=>j(e.target.value),style:{padding:"2px 4px",background:"#2a2a2a",color:"#eee",border:"1px solid #444",borderRadius:"4px"},children:[e.jsx("option",{value:"none",children:"No outlier prices filtered out"}),e.jsx("option",{value:"mild",children:"5th to 95th percentile (1.5 IQR)"}),e.jsx("option",{value:"moderate",children:"10th to 90th percentile (1.0 IQR)"}),e.jsx("option",{value:"strict",children:"25th to 75th percentile (0.5 IQR)"}),e.jsx("option",{value:"ultra",children:"37.5th to 62.5th percentile (0.25 IQR)"})]})]})]}),e.jsx("div",{className:"market-tabs-right",style:{display:"flex",alignItems:"center",gap:"1rem"}})]}),"orders"===c&&Object.keys(M).length>0&&e.jsx(me,{sellers:b,buyers:v,selectedRegion:l,locationInfoMap:M,activeTab:c,setActiveTab:d,itemName:r?.typeName}),"history"===c&&e.jsx(ge,{selectedItem:r,selectedRegion:l}),"distribution"===c&&e.jsx(he,{orders:q,regions:N,selectedRegion:l,onRegionClick:e=>{const t=N?.find(t=>t.regionName===e);t&&(a({regionID:t.regionID,regionName:t.regionName}),d("orders"))}})]})})]}),e.jsx(fe,{regionsData:N,filterOutliers:w})]})}export{pe as default};
