import{n as e,A as t,o as r,E as o}from"./common-C9hM7hE5.js";const a="marketHistoryCache.v1";async function s(o,a=null,s=null,n=null){const i=new URLSearchParams({type_id:o});a&&i.append("region_id",a),s&&i.append("location_id",s),null!==n&&i.append("is_buy_order",n),console.log(`üéØ Fetching market orders for type_id: ${o}, region_id: ${a}`);try{const s=19000001;if(a&&Number(a)!==s)try{const t=await e(a);if(t&&t.best_quotes&&t.best_quotes[o]){const e=t.best_quotes[o],r=e.best_buy?[{...e.best_buy,is_buy_order:!0,type_id:o,region_id:a}]:[];return{buyOrders:r,sellOrders:e.best_sell?[{...e.best_sell,is_buy_order:!1,type_id:o,region_id:a}]:[],meta:{source:"snapshot",last_updated:t.last_updated}}}}catch{}const n=`${t}/market/orders?${i}`,l=await r(n,{},1);if(console.log("‚úÖ Azure response received:",l),!l||"object"!=typeof l)throw new Error("Invalid response structure from Azure");const c={buyOrders:l.buyOrders||[],sellOrders:l.sellOrders||[],meta:l.meta||{}};return console.log(`üìä Azure orders: ${c.buyOrders.length} buy, ${c.sellOrders.length} sell`),c}catch(l){return console.error("‚ùå Azure fetch failed for market orders:",l),{buyOrders:[],sellOrders:[],meta:{source:"none"}}}}async function n(e,t,r=365){const s=`${e}:${t}`,n=function(){try{const e=localStorage.getItem(a);return e?JSON.parse(e):{}}catch{return{}}}(),i=Date.now(),l=n[s];if(l&&Array.isArray(l.data)){if(new Date(l.lastUpdated).toDateString()===new Date(i).toDateString())return l.data}const c=`${o}/markets/${t}/history/?type_id=${encodeURIComponent(e)}`;console.log(`üìà Fetching market history from ESI: type_id=${e}, region_id=${t}`);try{const e=await fetch(c,{headers:{"User-Agent":"EVE-Data-Site"}});if(!e.ok)throw new Error(`Failed to fetch market history: ${e.statusText} (${e.status})`);return function(e,t,r,o,s){const n=(Array.isArray(s)?s:[]).filter(e=>e&&e.date).sort((e,t)=>new Date(e.date)-new Date(t.date)).slice(-365);let i=n;if(o&&Array.isArray(o.data)&&o.data.length){const e=new Map(o.data.map(e=>[e.date,e]));for(const t of n)e.set(t.date,t);i=Array.from(e.values()).sort((e,t)=>new Date(e.date)-new Date(t.date)).slice(-365)}return r[e]={lastUpdated:t,data:i},function(e){try{localStorage.setItem(a,JSON.stringify(e))}catch{}}(r),i}(s,i,n,l,await e.json())}catch(u){if(console.warn(`üìà ESI history unavailable for type_id=${e}, region_id=${t}:`,u?.message||u),l&&Array.isArray(l.data))return l.data;throw u}}async function i(e){console.log("üåç fetchUniverseMarketHistory called with typeID:",e,typeof e);const t=[10000002,10000043,10000032,10000030,10000042];console.log("üåç Fetching from hubs:",t);const r=await Promise.all(t.map(async t=>{try{console.log(`üåç Fetching hub ${t} for typeID ${e}`);const r=await n(e,t);return console.log(`üåç Hub ${t} returned:`,r?r.length:"null","items"),r&&r.length>0&&console.log(`üåç Sample data from hub ${t}:`,r[0]),r}catch(r){return console.error(`üåç Hub ${t} failed:`,r),[]}}));console.log("üåç All hub responses:",r.map(e=>Array.isArray(e)?e.length:"not array"));const o=new Map;r.forEach((e,r)=>{console.log(`üåç Processing hub ${t[r]} with ${Array.isArray(e)?e.length:"not array"} items`),Array.isArray(e)&&e.forEach(e=>{const t=e.date;o.has(t)||o.set(t,{date:t,totalVolume:0,totalValue:0,highest:0,lowest:1/0,orderCount:0});const r=o.get(t),a=e.volume||0,s=e.average||0;r.totalVolume+=a,r.totalValue+=a*s,r.highest=Math.max(r.highest,e.highest||0),r.lowest=Math.min(r.lowest,e.lowest||r.lowest),r.orderCount+=e.order_count||0})}),console.log("üåç Date map size:",o.size);const a=Array.from(o.values()).map(e=>({date:e.date,average:e.totalVolume>0?e.totalValue/e.totalVolume:0,totalVolume:e.totalVolume,highest:e.highest,lowest:e.lowest===1/0?0:e.lowest,order_count:e.orderCount})).sort((e,t)=>new Date(e.date)-new Date(t.date));return console.log("üåç Final aggregated result:",a.length,"items"),a.length>0&&console.log("üåç Sample aggregated item:",a[0]),a}async function l(t,r=null){return async function(t,r){const o=Number(t),a=Number(r||t);try{const[t,r]=await Promise.all([e(o),e(a)]);if(!(t&&r&&t.best_quotes&&r.best_quotes))return[];const s=[],n=Object.keys(t.best_quotes);for(const e of n){const n=t.best_quotes[e],i=r.best_quotes[e];if(!n||!i)continue;const l=n.best_sell,c=i.best_buy;if(!l||!c)continue;const u=(c.price||0)-(l.price||0);if(u<=0)continue;const d=Math.min(Number(l.volume_remain||0),Number(c.volume_remain||0)),y=l.price>0?u/l.price*100:0;s.push({type_id:Number(e),origin_id:l.location_id,destination_id:c.location_id,sell_price:l.price,buy_price:c.price,profit_per_unit:u,profit_margin:y,max_volume:d,origin_region_id:o,destination_region_id:a,_fallback:!0})}return s.sort((e,t)=>(t.profit_per_unit||0)-(e.profit_per_unit||0)).slice(0,5e3)}catch{return[]}}(t,r||t)}export{n as a,s as b,l as c,i as f};
//# sourceMappingURL=market-D5TlsuZ8.js.map
