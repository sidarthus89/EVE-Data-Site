import{j as e}from"./index-B_2f2i0E.js";import{r as t,c as r}from"./react-vendor-BJsIi5Ft.js";import{h as a,R as n,k as l,g as s,i,j as o,l as c,m as u}from"./common-fh4CIMrf.js";import{c as m}from"./market-KLEb-izH.js";const d=(e,t=2)=>{if(null==e||isNaN(e))return"0";return parseFloat(e).toLocaleString("en-US",{minimumFractionDigits:t,maximumFractionDigits:t})},p={fromRegion:null,toRegion:null,nearbyOnly:!1,minProfit:"500000",maxWeight:"",minROI:4,maxJumps:"",maxBudget:"",salesTax:7.5,securityStatus:"any",structureType:"all",routePreference:"safest",hideOutOfStock:!1};function h(){const[h,y]=t.useState(p),[g,f]=t.useState(null),[x,b]=t.useState(null),[v,j]=t.useState(!1),[N,P]=t.useState([]),[w,_]=t.useState(null),[S,I]=t.useState(!1),[R,T]=t.useState([]),[k,C]=t.useState(1),[D]=t.useState(50),[M,F]=t.useState(!1),[B,J]=t.useState(!1),[O,L]=t.useState({key:"Net Profit",direction:"desc"}),[$,E]=t.useState(!1),[A,W]=t.useState(null),[Q,U]=t.useState(Date.now()),[V,z]=t.useState({Item:140,From:240,Quantity:110,"Buy Price":130,"Total Buy Price":140,To:240,"Sell Price":140,"Net Profit":140,Jumps:90,"Profit per Jump":150,"Profit Per Item":130,ROI:100,"Total Volume (m³)":120}),X=({label:t})=>{const r=V[t]||120;return e.jsxs("th",{onClick:()=>re(t),style:{width:r,minWidth:r,maxWidth:r,position:"relative"},children:[t,O.key===t?"asc"===O.direction?" ▲":" ▼":"",e.jsx("span",{className:"col-resizer",onMouseDown:e=>{e.stopPropagation(),((e,t,r)=>{const a=a=>{const n=(a.clientX||0)-t;z(t=>({...t,[e]:Math.max(60,Math.min(800,Math.round(r+n)))}))},n=()=>{window.removeEventListener("mousemove",a),window.removeEventListener("mouseup",n)};window.addEventListener("mousemove",a),window.addEventListener("mouseup",n)})(t,e.clientX||0,r)},title:"Drag to resize"})]})},q=e=>{const t=V[e]||120;return{width:t,minWidth:t,maxWidth:t}},H=(()=>{let e=null;return async t=>{try{if(!e){const t=await c();e=(e=>{const t=new Map,r=e=>{if(e&&"object"==typeof e){if(Array.isArray(e.items))for(const r of e.items){const e=Number(r.typeID);t.has(e)||t.set(e,{name:r.typeName,volume:r.volume||.01})}for(const t of Object.keys(e))"items"!==t&&"_info"!==t&&r(e[t])}};return r(e),t})(t)}const r=e.get(Number(t));return{volume:r?.volume||.01,name:r?.name||`Item ${t}`}}catch{return{volume:.01,name:`Item ${t}`}}}})(),G=r.useRef(new Map),K=async(e,t)=>{const r=`${e}->${t}`;if(G.current.has(r))return G.current.get(r);try{const a=await u(e,t);return G.current.set(r,a),a}catch{return G.current.set(r,null),null}};t.useEffect(()=>{const e=()=>{const e=document.querySelector(".hauling-form");if(e){const t=e.getBoundingClientRect(),r=60;F(t.top<=r)}};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[]);const Y=async e=>{try{await navigator.clipboard.writeText(e)}catch(t){}};t.useEffect(()=>{a().then(e=>{f(e)}).catch(e=>{console.error("🚛 ❌ Failed to load regions",e),_("Failed to load regions data")})},[]);const Z=t.useMemo(()=>g?g.map(e=>({regionID:e.region_id||e.regionID,regionName:e.region_name||e.regionName||e.name,...e})):[],[g]);t.useEffect(()=>{h.fromRegion&&Z.length,T([])},[h.fromRegion,Z]),t.useEffect(()=>{h.nearbyOnly&&R.length>0?y(e=>({...e,toRegion:{regionID:"nearby",regionName:`${R.length} Nearby Regions`}})):h.nearbyOnly||"nearby"!==h.toRegion?.regionID||y(e=>({...e,toRegion:null}))},[h.nearbyOnly,R]);const ee=(e,t)=>{y(r=>({...r,[e]:t}))},te=async(e,t,r)=>{try{const a=(await m(e,t)).filter(e=>{const t=e.profit_per_unit??e.buy_price-e.sell_price??0,a=e.max_volume??0,n=e.total_profit??t*a,l=e.profit_margin??(e.sell_price?t/e.sell_price*100:0),s=n>=parseFloat(r.minProfit||0),i=(e.sell_price??0)*a,o=!r.maxBudget||i<=parseFloat(r.maxBudget);return s&&l>=parseFloat(r.minROI||0)&&o});return await(async(e,t)=>{const[r,a]=await Promise.all([i(),o()]),n=new Map(a.map(e=>[Number(e.station_id||e.stationID),e])),l=new Map(r.map(e=>[Number(e.structureID??e.stationID),e]));if(!e||!Array.isArray(e))return[];const s=t.maxWeight?parseFloat(t.maxWeight):null,c=[];for(const i of e){const e=await H(i.type_id);let r=i.max_volume||0;if(s&&e.volume>0){const t=Math.floor(s/e.volume);r=Math.min(r,t)}if(t.maxBudget){const e=Number(t.maxBudget)||0,a=Number(i.sell_price||0);if(a>0){const t=Math.floor(e/a);r=Math.min(r,t)}}const a=Math.floor((r||0)*(e.volume||0));let o,u,m,d,p,h=null,y=null;if(i.origin_name&&i.destination_name)o=i.origin_name,u=i.destination_name,m=!0===(i.origin_is_npc??!0),d=!0===(i.destination_is_npc??!0),p=i.jumps??"N/A";else{const e=i.origin_id??i.from_location??i.source_station_id,t=i.destination_id??i.to_location??i.destination_station_id;h=n.get(e)||l.get(e)||{},y=n.get(t)||l.get(t)||{},h.name||console.warn(`Missing origin structure ID: ${e}`),y.name||console.warn(`Missing destination structure ID: ${t}`),o=h.name||`Unknown Station (ID: ${e})`,u=y.name||`Unknown Station (ID: ${t})`;const r=h&&("station"===h.type||1===h.is_npc||!0===h.is_npc),a=y&&("station"===y.type||1===y.is_npc||!0===y.is_npc);m=void 0===r||!!r,d=void 0===a||!!a,p=null;const s=i.origin_system_id||h?.system_id||h?.systemID||h?.solarSystemID,c=i.destination_system_id||y?.system_id||y?.systemID||y?.solarSystemID;s&&c&&(p=await K(s,c))}let g=i.origin_security??(h?h.security_status??h.security??null:null),f=i.destination_security??(y?y.security_status??y.security??null:null);g=null!=g?Number(g):g,f=null!=f?Number(f):f;const x=i.profit_per_jump??(p&&"number"==typeof p&&p>0?(i.profit_per_unit||0)*r/p:null);c.push({Item:i.name||e.name,From:{name:o,security:g,isNPC:m,systemId:i.origin_system_id||(h?h.system_id:null)},To:{name:u,security:f,isNPC:d,systemId:i.destination_system_id||(y?y.system_id:null)},"Buy Price":i.sell_price||0,"Sell Price":i.buy_price||0,"Profit Per Unit":i.profit_per_unit||0,"Profit Percentage":i.profit_margin||0,Quantity:r,"Total Volume (m3)":a,"Item Volume":i.volume||e.volume,Jumps:p,"Profit per Jump":x,"Total Profit":i.total_profit||(i.profit_per_unit||0)*r,ROI:i.profit_margin,_rawData:i})}let u=c;u=u.filter(e=>(Number(e.Quantity)||0)>0);const m=parseFloat(t.minProfit||"0"),d=parseFloat(t.minROI||"0"),p=t.maxBudget?parseFloat(t.maxBudget):null;if(u=u.filter(e=>{const t=Number(e.Quantity)||0,r=(Number(e["Buy Price"])||0)*t,a=Number(e["Total Profit"])||0,n=Number(e["Profit Percentage"])||0;return(null==p||r<=p)&&a>=m&&n>=d}),t.securityStatus&&"any"!==t.securityStatus){const e=e=>"number"==typeof e&&e>=.5,r=e=>"number"==typeof e&&e>0&&e<.5,a=e=>"number"==typeof e&&e<=0;u=u.filter(n=>{const l=n.From?.security,s=n.To?.security;return null!=l&&null!=s&&("highsec"===t.securityStatus?e(l)&&e(s):"lowsec"===t.securityStatus?r(l)&&r(s):"nullsec"!==t.securityStatus||a(l)&&a(s))})}if(t.structureType&&"all"!==t.structureType&&(u=u.filter(e=>{const r=!0===e.From?.isNPC,a=!0===e.To?.isNPC;return"avoid-player"===t.structureType?r&&a:"avoid-npc"!==t.structureType||!r&&!a})),t.maxJumps){const e=Number(t.maxJumps);Number.isFinite(e)&&(u=u.filter(t=>"number"!=typeof t.Jumps||t.Jumps<=e))}return u})(a,r)}catch(a){throw console.error("Error fetching or processing market orders:",a),new Error("Failed to fetch market orders.")}},re=e=>{L(t=>t.key===e?{key:e,direction:"asc"===t.direction?"desc":"asc"}:{key:e,direction:"asc"})},ae=t.useMemo(()=>{if(!O.key)return N;const e=[...N];return e.sort((e,t)=>{const r=(e,t)=>{switch(t){case"Item":return e.Item||"";case"From":return e.From&&e.From.name||e.From||"";case"To":return e.To&&e.To.name||e["Take To"]||"";case"Quantity":return e.Quantity||0;case"Buy Price":return e["Buy Price"]||0;case"Total Buy Price":return(e["Buy Price"]||0)*(e.Quantity||0);case"Sell Price":return e["Sell Price"]||0;case"Net Profit":return e["Total Profit"]||0;case"Jumps":return"number"==typeof e.Jumps?e.Jumps:0;case"Profit per Jump":return"number"==typeof e.Jumps&&e["Total Profit"]?e["Total Profit"]/e.Jumps:0;case"Profit Per Item":return e["Profit Per Unit"]||0;case"ROI":return e["Profit Percentage"]||0;case"Total Volume (m³)":return e["Total Volume (m3)"]||0;default:return e[t]||""}},a=r(e,O.key),n=r(t,O.key);return"number"==typeof a&&"number"==typeof n?"asc"===O.direction?a-n:n-a:"asc"===O.direction?String(a).localeCompare(String(n)):String(n).localeCompare(String(a))}),e},[N,O]);t.useEffect(()=>{let e=!0;const t=async()=>{try{const t=await l();e&&t&&W(new Date(t).getTime())}catch{}};t();const r=setInterval(t,6e4),a=setInterval(()=>U(Date.now()),1e3);return()=>{e=!1,clearInterval(r),clearInterval(a)}},[]);return g?e.jsxs("div",{className:"region-hauling",children:[e.jsx("div",{className:"static-header",children:e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{children:"Region to Region Trading"}),e.jsx("p",{className:"disclaimer",children:"This feature is still a WIP and may have issues."})]})}),e.jsxs("div",{className:"scrollable-content",children:[e.jsx("div",{className:"hauling-form",children:e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),P([]),C(1),j(!0),_(null),E(!1),!h.fromRegion?.regionID||!h.toRegion?.regionID)return _("Please select both source and destination regions"),void j(!1);try{const e=Number(h.fromRegion.regionID),t=Number(h.toRegion.regionID);console.log(`🚛 Searching for trade routes from ${h.fromRegion.regionName} (${e}) to ${h.toRegion.regionName} (${t})`);const r=await te(e,t,h);r.length>0?(P(r),I(r.some(e=>e._rawData&&e._rawData._fallback)),E(!0)):_("No profitable trades found for the selected criteria.")}catch(t){_(t.message)}finally{j(!1)}},children:[e.jsx("div",{className:"form-container",children:e.jsxs("div",{className:"form-row form-row-main",style:{display:"flex",justifyContent:"center",alignItems:"center",flexWrap:"nowrap",gap:"20px",padding:"0 20px",overflowX:"auto",margin:"0 auto 10px auto"},children:[e.jsxs("div",{className:"form-group region-group",children:[e.jsx("label",{children:"Starting Region"}),e.jsx(n,{selectedRegion:h.fromRegion,onRegionChange:e=>{y(t=>({...t,fromRegion:e,nearbyOnly:!(!t.nearbyOnly||!e)&&t.nearbyOnly}))},allowAllRegions:!1})]}),e.jsxs("div",{className:"form-group region-group",children:[e.jsx("label",{children:"Ending Region"}),h.nearbyOnly?e.jsx("div",{className:"nearby-region-display",children:"…"}):e.jsx(n,{selectedRegion:h.toRegion,onRegionChange:e=>{y(t=>({...t,toRegion:e,nearbyOnly:!1}))},allowAllRegions:!1})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Security"}),e.jsx("select",{value:h.securityStatus,onChange:e=>ee("securityStatus",e.target.value),className:"form-control",style:{width:"115px"},children:[{value:"any",label:"Any"},{value:"highsec",label:"High-Sec"},{value:"lowsec",label:"Low-Sec"},{value:"nullsec",label:"Null-Sec"}].map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Stations/Structures"}),e.jsx("select",{value:h.structureType,onChange:e=>ee("structureType",e.target.value),className:"form-control",style:{width:"165px"},children:[{value:"all",label:"All"},{value:"avoid-player",label:"Avoid Player Structures"},{value:"avoid-npc",label:"Avoid NPC Stations"}].map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Route"}),e.jsx("select",{value:h.routePreference,onChange:e=>ee("routePreference",e.target.value),className:"form-control",style:{width:"155px"},children:[{value:"safest",label:"Safest Route"},{value:"shortest",label:"Shortest Route"}].map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Max Jumps"}),e.jsx("input",{type:"number",value:h.maxJumps??"",onChange:e=>ee("maxJumps",e.target.value),placeholder:"∞",className:"form-control",style:{width:"80px"}})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Max Budget"}),e.jsx("input",{type:"number",value:h.maxBudget??"",onChange:e=>ee("maxBudget",e.target.value),placeholder:"∞",className:"form-control",style:{width:"165px"}})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Max Capacity (m³)"}),e.jsx("input",{type:"number",value:h.maxWeight??"",onChange:e=>ee("maxWeight",e.target.value),placeholder:"∞",className:"form-control",style:{width:"135px"}})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Sales Tax"}),e.jsx("select",{value:h.salesTax,onChange:e=>ee("salesTax",Number(e.target.value)),className:"form-control",style:{width:"155px"},children:[{level:0,tax:7.5,label:"No Skill: 7.5%"},{level:1,tax:6.675,label:"Lvl I: 6.675%"},{level:2,tax:5.85,label:"Lvl II: 5.85%"},{level:3,tax:5.025,label:"Lvl III: 5.025%"},{level:4,tax:4.2,label:"Lvl IV: 4.2%"},{level:5,tax:3.375,label:"Lvl V: 3.375%"}].map(t=>e.jsx("option",{value:t.tax,children:t.label},t.level))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Min Profit"}),e.jsx("input",{type:"number",value:h.minProfit??"",onChange:e=>ee("minProfit",e.target.value),placeholder:"0",className:"form-control",style:{width:"175px"}})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Min ROI %"}),e.jsx("input",{type:"number",value:h.minROI??"",onChange:e=>ee("minROI",e.target.value),placeholder:"0",className:"form-control",style:{width:"100px"}})]})]})}),w&&e.jsx("div",{className:"error-message",children:w}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"submit",disabled:v||!h.fromRegion||!h.toRegion,className:"eve-button",children:v?"Searching...":"Find Trade Routes"}),e.jsxs("span",{className:"update-timer",title:A?new Date(A).toLocaleString():"",style:{marginLeft:"16px",color:"#ccc",fontSize:"0.95rem",whiteSpace:"nowrap"},children:["Time Since Last Update: ",(()=>{if(!A)return"—";const e=Math.max(0,Q-A);return`${Math.floor(e/6e4)}m ${Math.floor(e%6e4/1e3)}s`})()]})]})]})}),$&&ae.length>0&&e.jsxs("div",{className:"results-container",children:[e.jsxs("div",{className:"results-header",children:[e.jsxs("h2",{children:["Trade Route Results (",ae.length," found)"]}),e.jsx("button",{onClick:()=>{P([]),_(null),C(1),I(!1),E(!1)},className:"new-search-btn",children:"Clear Results"})]}),e.jsx("div",{className:"results-table-container",children:e.jsxs("table",{className:"results-table wide-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(X,{label:"Item"}),e.jsx(X,{label:"From"}),e.jsx(X,{label:"Quantity"}),e.jsx(X,{label:"Buy Price"}),e.jsx(X,{label:"Total Buy Price"}),e.jsx(X,{label:"To"}),e.jsx(X,{label:"Sell Price"}),e.jsx(X,{label:"Net Profit"}),e.jsx(X,{label:"Jumps"}),e.jsx(X,{label:"Profit per Jump"}),e.jsx(X,{label:"Profit Per Item"}),e.jsx(X,{label:"ROI"}),e.jsx(X,{label:"Total Volume (m³)"})]})}),e.jsx("tbody",{children:(()=>{const t=(k-1)*D,r=t+D;return ae.slice(t,r).map((r,a)=>{const n=r.Item||"Unknown Item",l=r.From||{},i=r.To||r["Take To"]||{},o=r["Buy Price"]||0,c=r["Sell Price"]||0,u=r["Profit Per Unit"]||0,m=r["Profit Percentage"]||0,p=r["Total Profit"]||0,h=r.Quantity||0,y=r["Total Volume (m3)"]||0,g=r.Jumps||"N/A",f=o*h,x="number"==typeof g&&g>0?p/g:null,b=t=>{if("string"==typeof t)return e.jsx("span",{className:"clickable-location",onClick:()=>Y(t),title:"Click to copy to clipboard",children:t});const r=t.name||"Unknown Station",a=t.security,n=t.isNPC;let l="#ffffff";return null!=a&&(l=s(a)),e.jsx("span",{className:"clickable-location",style:{color:l},onClick:()=>Y(r),title:`Security: ${null!=a?a.toFixed(1):"Unknown"} | ${n?"NPC Station":"Player Structure"} | Click to copy`,children:r})};return e.jsxs("tr",{children:[e.jsx("td",{style:q("Item"),children:e.jsx("span",{className:"clickable-location",onClick:()=>Y(n),title:"Click to copy item name",children:n})}),e.jsx("td",{style:q("From"),children:b(l)}),e.jsx("td",{style:q("Quantity"),children:d(h,0)}),e.jsx("td",{style:q("Buy Price"),children:d(o)}),e.jsx("td",{style:q("Total Buy Price"),children:d(f)}),e.jsx("td",{style:q("To"),children:b(i)}),e.jsx("td",{style:q("Sell Price"),children:d(c)}),e.jsx("td",{style:q("Net Profit"),children:d(p)}),e.jsx("td",{style:q("Jumps"),children:"number"==typeof g?g:"N/A"}),e.jsx("td",{style:q("Profit per Jump"),children:null!=x?d(x):"-"}),e.jsx("td",{style:q("Profit Per Item"),children:d(u)}),e.jsxs("td",{style:q("ROI"),children:[d(m,1),"%"]}),e.jsx("td",{style:q("Total Volume (m³)"),children:d(y,0)})]},t+a)})})()})]})}),ae.length>D&&e.jsx("div",{className:"pagination-container",children:e.jsxs("div",{className:"pagination",children:[e.jsx("button",{onClick:()=>C(e=>Math.max(e-1,1)),disabled:1===k,className:"pagination-btn",children:"Previous"}),e.jsxs("span",{className:"pagination-info",children:["Page ",k," of ",Math.ceil(ae.length/D),"(",ae.length," total results)"]}),e.jsx("button",{onClick:()=>C(e=>Math.min(e+1,Math.ceil(ae.length/D))),disabled:k>=Math.ceil(ae.length/D),className:"pagination-btn",children:"Next"})]})})]})]}),e.jsx("div",{className:"return-to-top",onClick:()=>window.scrollTo({top:0,behavior:"smooth"}),title:"Return to Top",children:"↑"})]}):e.jsx("div",{className:"region-hauling",children:e.jsx("div",{className:"loading-container",children:e.jsx("p",{children:"Loading regions..."})})})}export{h as default};
//# sourceMappingURL=RegionHauling-Do0KAMP8.js.map
