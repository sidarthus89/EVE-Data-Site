import{j as e}from"./index-DcAEGjlW.js";import{r as t,b as n,u as i}from"./react-vendor-BmSviu0-.js";import{R as s,f as r,g as o,c as l,a,b as c,t as d,d as u,m as h,e as m}from"./common-DSNZ1I22.js";import{G as g}from"./icons-BbxVzVXe.js";import{u as f,f as p,g as y,a as x,b,c as v}from"./index-CLH8oIme.js";import{R as S,C as j,X as w,Y as k,T as N,L as C,B as I,a as z,b as E,A as M}from"./chart-vendor-CwcEfXkA.js";import{f as R,a as D,b as _,s as A}from"./stations-B1VLn3hK.js";function O({marketTree:n,expandedNodes:i,setExpandedNodes:s,onItemSelect:r}){const[o,l]=t.useState(""),[a,c]=t.useState([]);t.useEffect(()=>{if(o.length>=4){const e=function(e,t){const n=[],i=new Set;function s(t){if(null!==t&&"object"==typeof t&&!i.has(t)){if(i.add(t),Array.isArray(t.items)){const i=t.items.filter(t=>t.typeName?.toLowerCase().includes(e.toLowerCase()));n.push(...i)}for(const[e,n]of Object.entries(t))["_info","items"].includes(e)||s(n)}}return Array.isArray(t)?t.forEach(s):s(t),n}(o,n),t=e.sort((e,t)=>e.typeName.localeCompare(t.typeName));c(t)}else c([])},[o,n]);const d=t.useRef();t.useEffect(()=>{function e(e){d.current&&!d.current.contains(e.target)&&c([])}function t(e){"Escape"===e.key&&c([])}return document.addEventListener("mousedown",e),document.addEventListener("keydown",t),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",t)}},[]);const u=e=>{const t=F(e.typeID,n);if(t){const e=new Set(i);t.reduce((t,n)=>{const i=[...t,n].join("/");return e.add(i),[...t,n]},[]),s(e)}r(e),c([]),l(e.typeName)};return e.jsxs("div",{className:"search-bar",ref:d,children:[e.jsx("input",{type:"text",placeholder:"Search",value:o,onChange:e=>{const t=e.target.value;l(t)},onKeyDown:e=>{if("Enter"===e.key){const e=a.find(e=>e.typeName===o);e&&u(e)}}}),e.jsx("span",{className:"search-clear",title:"Clear Search",onClick:()=>{l(""),c([])},children:"╳"}),o.length>=4&&a.length>0&&e.jsx("ul",{className:"search-suggestions",children:a.map(t=>e.jsx("li",{onClick:()=>u(t),className:"suggestion-item",children:t.typeName},t.typeID))})]})}function F(e,t,n=[],i=new Set){if(null===t||"object"!=typeof t)return null;if(i.has(t))return null;i.add(t);for(const[s,r]of Object.entries(t)){if("object"!=typeof r||null===r)continue;const t=[...n,s];if(Array.isArray(r.items)){if(r.items.find(t=>String(t.typeID)===String(e)))return t}for(const[n,s]of Object.entries(r)){if(["_info","items"].includes(n))continue;if("object"!=typeof s||null===s)continue;const r=F(e,s,[...t,n],i);if(r)return r}}return null}const L="eveQuickbar";function T({onItemSelect:n}){const[i,s]=t.useState([]);t.useEffect(()=>{const e=localStorage.getItem(L);if(e)try{s(JSON.parse(e))}catch(t){}},[]),t.useEffect(()=>{const e=e=>{const t=e.detail;s(e=>{if(e.some(e=>e.typeID===t.typeID))return e;const n=[...e,t];return localStorage.setItem(L,JSON.stringify(n)),n})};return window.addEventListener("quickbar:add",e),()=>window.removeEventListener("quickbar:add",e)},[]);return 0===i.length?e.jsxs("div",{className:"quickbar-empty",children:[e.jsx("p",{children:"No items in quickbar"}),e.jsx("p",{className:"quickbar-hint",children:"Hover over items in the market tree and click the + button to add them here"})]}):e.jsx("div",{className:"quickbar",children:i.map(t=>e.jsxs("div",{className:"quickbar-item",children:[e.jsxs("div",{className:"quickbar-item-name",onClick:()=>n?.(t),children:[e.jsx("img",{src:`https://images.evetech.net/types/${t.typeID}/icon?size=32`,alt:"",className:"quickbar-item-icon"}),e.jsx("span",{children:t.typeName})]}),e.jsx("button",{className:"quickbar-remove-btn",onClick:()=>{return e=t.typeID,void s(t=>{const n=t.filter(t=>t.typeID!==e);return localStorage.setItem(L,JSON.stringify(n)),n});var e},title:"Remove from quickbar",children:"×"})]},t.typeID))})}const V="marketTreeState",P="selectedItemID";function W({node:t,nodeName:n,path:i,onItemSelect:s,expandedNodes:r,toggleNode:o}){const l=[...i,n],a=l.join("/"),c=r.has(a),d=Object.keys(t).some(e=>!["_info","items","name"].includes(e)),u=Array.isArray(t.items)&&t.items.length>0;return e.jsxs("li",{children:[e.jsxs("div",{className:"tree-group-header",onClick:()=>o(a),children:[t._info?.iconFile&&e.jsx("img",{src:t._info?.iconFile?`/EVE-Data-Site/assets/marketGroupIcons/${t._info.iconFile}`:"/EVE-Data-Site/assets/marketGroupIcons/defaultGroupIcon.png",alt:"",className:"group-icon",onError:e=>{e.target.onerror=null,e.target.src="/EVE-Data-Site/assets/marketGroupIcons/defaultGroupIcon.png"}}),n]}),c&&e.jsxs(e.Fragment,{children:[u&&e.jsx("ul",{children:t.items.map(t=>e.jsxs("li",{className:"market-item with-button",children:[e.jsx("span",{id:`item-${t.typeID}`,className:"item-name",onClick:()=>{localStorage.setItem(P,t.typeID),s?.(t)},children:t.typeName}),e.jsx("button",{className:"quickbar-add-btn",title:"Add to Quickbar",onClick:e=>{e.stopPropagation(),window.dispatchEvent(new CustomEvent("quickbar:add",{detail:{typeID:t.typeID,typeName:t.typeName,groupID:t.groupID,categoryID:t.categoryID}}))},children:"+"})]},t.typeID))}),d&&e.jsx("ul",{children:Object.entries(t).map(([t,n])=>"_info"===t||"items"===t||"name"===t?null:e.jsx(W,{node:n,nodeName:t,path:l,onItemSelect:s,expandedNodes:r,toggleNode:o},[...l,t].join("/")))})]})]})}function K({marketTree:n,onItemSelect:i,breadcrumbPath:s}){const[r,o]=t.useState(new Set);function l(e){o(t=>{const n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n})}function a(e){o(t=>{const n=new Set(t);for(let i=0;i<e.length;i++){const t=e.slice(0,i+1).join("/");n.add(t)}return n})}return t.useEffect(()=>{const e=localStorage.getItem(V);if(e)try{o(new Set(JSON.parse(e)))}catch(t){}},[]),t.useEffect(()=>{localStorage.setItem(V,JSON.stringify([...r]))},[r]),t.useEffect(()=>{s&&s.length>0&&o(e=>{const t=new Set(e);for(let n=0;n<s.length;n++){const e=s.slice(0,n+1).join("/");t.add(e)}return t})},[s]),t.useEffect(()=>{"undefined"!=typeof window&&(window.marketTreeNavigate=a)},[]),t.useEffect(()=>{if(!s||0===s.length||!n)return;const e=localStorage.getItem(P);e&&setTimeout(()=>{const t=document.getElementById(`item-${e}`);t&&t.scrollIntoView({behavior:"smooth",block:"center"})},100)},[s,n]),n?e.jsx("ul",{className:"menuList menuListtop",children:n.map((t,n)=>e.jsx(W,{node:t,nodeName:t.name,path:[],onItemSelect:i,expandedNodes:r,toggleNode:l},t.name||n))}):null}function $({selectedRegion:n,onRegionChange:i,regions:r,onItemSelect:o,marketTree:l,breadcrumbPath:a}){const[c,d]=t.useState("market"),[u,h]=t.useState(new Set),m=t.useRef(null),g=t.useRef(null),f=t.useRef(null);t.useEffect(()=>{const e=()=>{const e=m.current,t="market"===c?g.current:f.current;e&&t&&(e.style.setProperty("--underline-x",`${t.offsetLeft}px`),e.style.setProperty("--underline-width",`${t.offsetWidth}px`))},t=setTimeout(e,10);return window.addEventListener("resize",e),()=>{clearTimeout(t),window.removeEventListener("resize",e)}},[c]);const p=e=>d(e);return e.jsxs("aside",{id:"sidebar",className:"sidebar",children:[e.jsxs("div",{className:"sidebar-header",children:[e.jsx("div",{className:"regionSelector-wrapper",children:e.jsx(s,{selectedRegion:n,onRegionChange:i,regions:r})}),e.jsxs("div",{className:"search-wrapper",children:[e.jsx(O,{marketTree:l,expandedNodes:u,setExpandedNodes:h,onItemSelect:o}),e.jsx("button",{className:"collapse-button",title:"Collapse all groups",onClick:()=>h(new Set),children:e.jsx("img",{src:"/assets/collapse.png",alt:"Collapse"})})]}),e.jsx("div",{className:"tab-container",ref:m,children:e.jsxs("div",{className:"sidebar-tabs",children:[e.jsx("button",{ref:g,className:"sidebar-tab-link "+("market"===c?"active":""),onClick:()=>p("market"),children:"Market"}),e.jsx("button",{ref:f,className:"sidebar-tab-link "+("quickbar"===c?"active":""),onClick:()=>p("quickbar"),children:"Quickbar"})]})})]}),e.jsxs("div",{className:"sidebar-scrollable",children:["market"===c&&l&&e.jsx(K,{marketTree:l,onItemSelect:o,breadcrumbPath:a}),"quickbar"===c&&e.jsx(T,{onItemSelect:o})]})]})}function q(e){return g({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polyline",attr:{points:"20 6 9 17 4 12"},child:[]}]})(e)}function B(e){return g({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"polygon",attr:{points:"22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"},child:[]}]})(e)}function U(e){return g({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"},child:[]},{tag:"path",attr:{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"},child:[]}]})(e)}function H(e){return g({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"line",attr:{x1:"18",y1:"6",x2:"6",y2:"18"},child:[]},{tag:"line",attr:{x1:"6",y1:"6",x2:"18",y2:"18"},child:[]}]})(e)}function X({selectedItem:n,marketTree:i,onBreadcrumbClick:s}){const[r,o]=t.useState([]),[l,a]=t.useState(!1);t.useEffect(()=>{if(n?.typeID&&i){const e=function(e,t){const n=Number(e);let i=[];function s(e){return Array.isArray(e)&&e.some(e=>e&&"object"==typeof e&&Number(e.typeID)===n)}function r(e){return e}function o(e,t=[],n){if(!e||"object"!=typeof e)return!1;if(0===t.length&&n){t=[{key:n,name:r(n)}]}if(s(e.items))return i=t.map(e=>e.name),!0;for(const[r,o]of Object.entries(e))if("_info"!==r&&"items"!==r&&Array.isArray(o)&&s(o))return i=t.map(e=>e.name),!0;for(const[i,s]of Object.entries(e))if("_info"!==i&&"items"!==i&&s&&"object"==typeof s&&!Array.isArray(s)){const e=r(i);if(o(s,[...t,{key:i,name:e}],i))return!0}return!1}if(Array.isArray(t)){for(const l of t)if(l&&"object"==typeof l){if(o(l,[],l.name||"Unknown"))return i}}else for(const[l,a]of Object.entries(t))if(a&&"object"==typeof a&&!Array.isArray(a)&&o(a,[],l))return i;return["Unknown Category"]}(n.typeID,i);o(e)}},[n,i]);const c=`https://images.evetech.net/types/${n?.typeID}/icon?size=64`;return n?e.jsxs("div",{className:"item-viewer",children:[e.jsx("img",{src:c,alt:n.typeName,className:"item-icon",onError:e=>e.target.src="/assets/fallback_icon.png"}),e.jsxs("div",{className:"item-details",children:[e.jsx("div",{className:"breadcrumb",children:r.map((t,n)=>e.jsxs("span",{children:[e.jsx("a",{href:"#",onClick:e=>{e.preventDefault(),s(r.slice(0,n+1))},children:t}),n<r.length-1&&e.jsx("span",{children:" / "})]},n))}),e.jsxs("div",{className:"item-header-row",children:[e.jsx("div",{className:"item-name",children:n.typeName}),e.jsx("button",{className:"quickbar-btn",onClick:()=>{const e="eveQuickbar",t=JSON.parse(localStorage.getItem(e)||"[]");t.some(e=>e.typeID===n.typeID)||localStorage.setItem(e,JSON.stringify([...t,n]))},title:"Add to Quickbar",children:"Add to Quickbar"}),e.jsxs("div",{style:{position:"relative"},children:[e.jsx("button",{onClick:async()=>{const e=`${`${window.location.origin}/EVE-Data-Site/market`}?item=${n.typeID}`;try{await navigator.clipboard.writeText(e),a(!0),setTimeout(()=>a(!1),2e3)}catch(t){}},className:"item-link",title:"Copy market link",children:l?e.jsx(q,{className:"icon"}):e.jsx(U,{className:"icon"})}),l&&e.jsx("div",{className:"copy-tooltip",style:{top:"-30px",left:"0"},children:"Link copied!"})]})]})]})]}):null}function Q(e,t,n){let i,s=n.initialDeps??[];function r(){var r,o,l,a;let c;n.key&&(null==(r=n.debug)?void 0:r.call(n))&&(c=Date.now());const d=e();if(!(d.length!==s.length||d.some((e,t)=>s[t]!==e)))return i;let u;if(s=d,n.key&&(null==(o=n.debug)?void 0:o.call(n))&&(u=Date.now()),i=t(...d),n.key&&(null==(l=n.debug)?void 0:l.call(n))){Math.round(100*(Date.now()-c)),Math.round(100*(Date.now()-u))}return null==(a=null==n?void 0:n.onChange)||a.call(n,i),i}return r.updateDeps=e=>{s=e},r}function G(e,t){if(void 0===e)throw new Error("Unexpected undefined");return e}const J=(e,t,n)=>{let i;return function(...s){e.clearTimeout(i),i=e.setTimeout(()=>t.apply(this,s),n)}},Y=e=>{const{offsetWidth:t,offsetHeight:n}=e;return{width:t,height:n}},Z=e=>e,ee=e=>{const t=Math.max(e.startIndex-e.overscan,0),n=Math.min(e.endIndex+e.overscan,e.count-1),i=[];for(let s=t;s<=n;s++)i.push(s);return i},te=(e,t)=>{const n=e.scrollElement;if(!n)return;const i=e.targetWindow;if(!i)return;const s=e=>{const{width:n,height:i}=e;t({width:Math.round(n),height:Math.round(i)})};if(s(Y(n)),!i.ResizeObserver)return()=>{};const r=new i.ResizeObserver(t=>{const i=()=>{const e=t[0];if(null==e?void 0:e.borderBoxSize){const t=e.borderBoxSize[0];if(t)return void s({width:t.inlineSize,height:t.blockSize})}s(Y(n))};e.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(i):i()});return r.observe(n,{box:"border-box"}),()=>{r.unobserve(n)}},ne={passive:!0},ie="undefined"==typeof window||"onscrollend"in window,se=(e,t)=>{const n=e.scrollElement;if(!n)return;const i=e.targetWindow;if(!i)return;let s=0;const r=e.options.useScrollendEvent&&ie?()=>{}:J(i,()=>{t(s,!1)},e.options.isScrollingResetDelay),o=i=>()=>{const{horizontal:o,isRtl:l}=e.options;s=o?n.scrollLeft*(l?-1:1):n.scrollTop,r(),t(s,i)},l=o(!0),a=o(!1);a(),n.addEventListener("scroll",l,ne);const c=e.options.useScrollendEvent&&ie;return c&&n.addEventListener("scrollend",a,ne),()=>{n.removeEventListener("scroll",l),c&&n.removeEventListener("scrollend",a)}},re=(e,t,n)=>{if(null==t?void 0:t.borderBoxSize){const e=t.borderBoxSize[0];if(e){return Math.round(e[n.options.horizontal?"inlineSize":"blockSize"])}}return e[n.options.horizontal?"offsetWidth":"offsetHeight"]},oe=(e,{adjustments:t=0,behavior:n},i)=>{var s,r;const o=e+t;null==(r=null==(s=i.scrollElement)?void 0:s.scrollTo)||r.call(s,{[i.options.horizontal?"left":"top"]:o,behavior:n})};class le{constructor(e){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let e=null;const t=()=>e||(this.targetWindow&&this.targetWindow.ResizeObserver?e=new this.targetWindow.ResizeObserver(e=>{e.forEach(e=>{const t=()=>{this._measureElement(e.target,e)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(t):t()})}):null);return{disconnect:()=>{var n;null==(n=t())||n.disconnect(),e=null},observe:e=>{var n;return null==(n=t())?void 0:n.observe(e,{box:"border-box"})},unobserve:e=>{var n;return null==(n=t())?void 0:n.unobserve(e)}}})(),this.range=null,this.setOptions=e=>{Object.entries(e).forEach(([t,n])=>{void 0===n&&delete e[t]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:Z,rangeExtractor:ee,onChange:()=>{},measureElement:re,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...e}},this.notify=e=>{var t,n;null==(n=(t=this.options).onChange)||n.call(t,this,e)},this.maybeNotify=Q(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),e=>{this.notify(e)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(e=>e()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var e;const t=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==t){if(this.cleanup(),!t)return void this.maybeNotify();this.scrollElement=t,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=(null==(e=this.scrollElement)?void 0:e.window)??null,this.elementsCache.forEach(e=>{this.observer.observe(e)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,e=>{this.scrollRect=e,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(e,t)=>{this.scrollAdjustments=0,this.scrollDirection=t?this.getScrollOffset()<e?"forward":"backward":null,this.scrollOffset=e,this.isScrolling=t,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??("function"==typeof this.options.initialOffset?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(e,t)=>{const n=new Map,i=new Map;for(let s=t-1;s>=0;s--){const t=e[s];if(n.has(t.lane))continue;const r=i.get(t.lane);if(null==r||t.end>r.end?i.set(t.lane,t):t.end<r.end&&n.set(t.lane,!0),n.size===this.options.lanes)break}return i.size===this.options.lanes?Array.from(i.values()).sort((e,t)=>e.end===t.end?e.index-t.index:e.end-t.end)[0]:void 0},this.getMeasurementOptions=Q(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(e,t,n,i,s)=>(this.pendingMeasuredCacheIndexes=[],{count:e,paddingStart:t,scrollMargin:n,getItemKey:i,enabled:s}),{key:!1}),this.getMeasurements=Q(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:e,paddingStart:t,scrollMargin:n,getItemKey:i,enabled:s},r)=>{if(!s)return this.measurementsCache=[],this.itemSizeCache.clear(),[];0===this.measurementsCache.length&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(e=>{this.itemSizeCache.set(e.key,e.size)}));const o=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const l=this.measurementsCache.slice(0,o);for(let a=o;a<e;a++){const e=i(a),s=1===this.options.lanes?l[a-1]:this.getFurthestMeasurement(l,a),o=s?s.end+this.options.gap:t+n,c=r.get(e),d="number"==typeof c?c:this.options.estimateSize(a),u=o+d,h=s?s.lane:a%this.options.lanes;l[a]={index:a,start:o,size:d,end:u,key:e,lane:h}}return this.measurementsCache=l,l},{key:!1,debug:()=>this.options.debug}),this.calculateRange=Q(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(e,t,n,i)=>this.range=e.length>0&&t>0?function({measurements:e,outerSize:t,scrollOffset:n,lanes:i}){const s=e.length-1,r=t=>e[t].start;if(e.length<=i)return{startIndex:0,endIndex:s};let o=ae(0,s,r,n),l=o;if(1===i)for(;l<s&&e[l].end<n+t;)l++;else if(i>1){const r=Array(i).fill(0);for(;l<s&&r.some(e=>e<n+t);){const t=e[l];r[t.lane]=t.end,l++}const a=Array(i).fill(n+t);for(;o>=0&&a.some(e=>e>=n);){const t=e[o];a[t.lane]=t.start,o--}o=Math.max(0,o-o%i),l=Math.min(s,l+(i-1-l%i))}return{startIndex:o,endIndex:l}}({measurements:e,outerSize:t,scrollOffset:n,lanes:i}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=Q(()=>{let e=null,t=null;const n=this.calculateRange();return n&&(e=n.startIndex,t=n.endIndex),this.maybeNotify.updateDeps([this.isScrolling,e,t]),[this.options.rangeExtractor,this.options.overscan,this.options.count,e,t]},(e,t,n,i,s)=>null===i||null===s?[]:e({startIndex:i,endIndex:s,overscan:t,count:n}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=e=>{const t=this.options.indexAttribute,n=e.getAttribute(t);return n?parseInt(n,10):-1},this._measureElement=(e,t)=>{const n=this.indexFromElement(e),i=this.measurementsCache[n];if(!i)return;const s=i.key,r=this.elementsCache.get(s);r!==e&&(r&&this.observer.unobserve(r),this.observer.observe(e),this.elementsCache.set(s,e)),e.isConnected&&this.resizeItem(n,this.options.measureElement(e,t,this))},this.resizeItem=(e,t)=>{const n=this.measurementsCache[e];if(!n)return;const i=t-(this.itemSizeCache.get(n.key)??n.size);0!==i&&((void 0!==this.shouldAdjustScrollPositionOnItemSizeChange?this.shouldAdjustScrollPositionOnItemSizeChange(n,i,this):n.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=i,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(n.index),this.itemSizeCache=new Map(this.itemSizeCache.set(n.key,t)),this.notify(!1))},this.measureElement=e=>{e?this._measureElement(e,void 0):this.elementsCache.forEach((e,t)=>{e.isConnected||(this.observer.unobserve(e),this.elementsCache.delete(t))})},this.getVirtualItems=Q(()=>[this.getVirtualIndexes(),this.getMeasurements()],(e,t)=>{const n=[];for(let i=0,s=e.length;i<s;i++){const s=t[e[i]];n.push(s)}return n},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=e=>{const t=this.getMeasurements();if(0!==t.length)return G(t[ae(0,t.length-1,e=>G(t[e]).start,e)])},this.getOffsetForAlignment=(e,t,n=0)=>{const i=this.getSize(),s=this.getScrollOffset();"auto"===t&&(t=e>=s+i?"end":"start"),"center"===t?e+=(n-i)/2:"end"===t&&(e-=i);const r=this.getTotalSize()+this.options.scrollMargin-i;return Math.max(Math.min(r,e),0)},this.getOffsetForIndex=(e,t="auto")=>{e=Math.max(0,Math.min(e,this.options.count-1));const n=this.measurementsCache[e];if(!n)return;const i=this.getSize(),s=this.getScrollOffset();if("auto"===t)if(n.end>=s+i-this.options.scrollPaddingEnd)t="end";else{if(!(n.start<=s+this.options.scrollPaddingStart))return[s,t];t="start"}const r="end"===t?n.end+this.options.scrollPaddingEnd:n.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(r,t,n.size),t]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(e,{align:t="start",behavior:n}={})=>{"smooth"===n&&this.isDynamicMode(),this._scrollToOffset(this.getOffsetForAlignment(e,t),{adjustments:void 0,behavior:n})},this.scrollToIndex=(e,{align:t="auto",behavior:n}={})=>{"smooth"===n&&this.isDynamicMode(),e=Math.max(0,Math.min(e,this.options.count-1));let i=0;const s=t=>{if(!this.targetWindow)return;const i=this.getOffsetForIndex(e,t);if(!i)return;const[s,o]=i;this._scrollToOffset(s,{adjustments:void 0,behavior:n}),this.targetWindow.requestAnimationFrame(()=>{const t=this.getScrollOffset(),n=this.getOffsetForIndex(e,o);var i,s;n&&(i=n[0],s=t,Math.abs(i-s)<1.01||r(o))})},r=e=>{this.targetWindow&&(i++,i<10&&this.targetWindow.requestAnimationFrame(()=>s(e)))};s(t)},this.scrollBy=(e,{behavior:t}={})=>{"smooth"===t&&this.isDynamicMode(),this._scrollToOffset(this.getScrollOffset()+e,{adjustments:void 0,behavior:t})},this.getTotalSize=()=>{var e;const t=this.getMeasurements();let n;if(0===t.length)n=this.options.paddingStart;else if(1===this.options.lanes)n=(null==(e=t[t.length-1])?void 0:e.end)??0;else{const e=Array(this.options.lanes).fill(null);let i=t.length-1;for(;i>=0&&e.some(e=>null===e);){const n=t[i];null===e[n.lane]&&(e[n.lane]=n.end),i--}n=Math.max(...e.filter(e=>null!==e))}return Math.max(n-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(e,{adjustments:t,behavior:n})=>{this.options.scrollToFn(e,{behavior:n,adjustments:t},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(e)}}const ae=(e,t,n,i)=>{for(;e<=t;){const s=(e+t)/2|0,r=n(s);if(r<i)e=s+1;else{if(!(r>i))return s;t=s-1}}return e>0?e-1:0};const ce="undefined"!=typeof document?t.useLayoutEffect:t.useEffect;function de(e){return function(e){const i=t.useReducer(()=>({}),{})[1],s={...e,onChange:(t,s)=>{var r;s?n.flushSync(i):i(),null==(r=e.onChange)||r.call(e,t,s)}},[r]=t.useState(()=>new le(s));return r.setOptions(s),ce(()=>r._didMount(),[]),ce(()=>r._willUpdate()),r}({observeElementRect:te,observeElementOffset:se,scrollToFn:oe,...e})}function ue({sellers:n,buyers:i,selectedRegion:s,locationInfoMap:u,activeTab:h,setActiveTab:m,itemName:g}){const[S,j]=t.useState({seller:null,buyer:null}),[w,k]=t.useState({seller:{},buyer:{}}),[N,C]=t.useState({seller:{},buyer:{}}),[I,z]=t.useState(new Set),E=t.useRef(null),[M,R]=t.useState({sellerSorting:[{id:"price",desc:!1}],buyerSorting:[{id:"price",desc:!0}],sellerSizing:{},buyerSizing:{},sellerColumnFilters:[],buyerColumnFilters:[]}),D=t.useRef(),_=t.useRef();t.useEffect(()=>{const e=e=>{E.current&&!E.current.contains(e.target)&&(j(e=>({...e,seller:null,buyer:null})),C(e=>({...e,seller:{},buyer:{}})))};return document.addEventListener("mousedown",e),document.addEventListener("touchstart",e),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("touchstart",e)}},[]);const A=(e,t,n)=>{if(!n||0===n.length)return!0;let i=e.getValue(t);if("security"===t){i=`${d(Number(i)||0).toFixed(1)}`}else if("station_type"===t){const t=u[Number(e.original.location_id)]?.isNPC;i=t?"NPC":"Player"}else if("location_name"===t){const e=u[Number(i)];i=l(e?.name||"")}else if("region_name"===t){const e=u[Number(i)];i=l(e?.regionName||"")}else"range"===t&&(i=c(i));return n.includes(String(i))},O=async(e,t)=>{const n=u[Number(e)],i=n?.name;if(!i)return;await(async e=>{try{return await navigator.clipboard.writeText(e),!0}catch(t){return!1}})(i)&&(z(e=>new Set(e).add(t)),setTimeout(()=>{z(e=>{const n=new Set(e);return n.delete(t),n})},2e3))},F=(e,t)=>{const n=new Set;return e.forEach(e=>{if("security"===t){const t=u[Number(e.location_id)]?.security;if(null!=t){const e=d(t);n.add(`${e.toFixed(1)}`)}}else if("station_type"===t){const t=u[Number(e.location_id)]?.isNPC;n.add(t?"NPC":"Player")}else if("location_name"===t){const t=u[Number(e.location_id)]?.name;t&&n.add(l(t))}else if("region_name"===t){const t=u[Number(e.location_id)]?.regionName;t&&n.add(l(t))}else"range"===t&&n.add(c(e[t]))}),Array.from(n).sort()},L=e=>{j(t=>({...t,[e]:null})),C(t=>({...t,[e]:{}}))},T=t.useMemo(()=>{if(!s||"all"===s.regionID)return n||[];const e=s.regionName;return(n||[]).filter(t=>{const n=u[Number(t.location_id)];return(n?.regionName||"Unknown")===e})},[n,s,u]),V=t.useMemo(()=>{if(!s||"all"===s.regionID)return i||[];const e=s.regionName;return(i||[]).filter(t=>{const n=u[Number(t.location_id)];return(n?.regionName||"Unknown")===e})},[i,s,u]),P=t.useMemo(()=>[{accessorKey:"volume_remain",header:"Quantity",size:96},{accessorKey:"price",header:"Price",cell:e=>r(e.getValue()),size:160},{accessorFn:e=>{const t=u[Number(e.location_id)]?.security;return null==t?null:t},id:"security",header:"Sec.",cell:t=>{const n=t.row.original.location_id,i=u[n]?.security;return"number"==typeof i?e.jsx("span",{style:{color:o(i)},children:i.toFixed(1)}):e.jsx("span",{children:"—"})},size:78},{accessorFn:e=>{const t=u[Number(e.location_id)]?.isNPC;return t?"NPC":"Player"},id:"station_type",header:"Type",cell:t=>{const n=t.getValue();return e.jsx("span",{style:{color:"NPC"===n?"#4CAF50":"#2196F3",fontWeight:"500"},children:n})},size:65},{accessorKey:"location_id",id:"location_name",header:"Location",cell:t=>{const n=t.getValue(),i=l(u[n]?.name||"Unknown"),s=`${t.column.id}-${t.row.id}`,r=I.has(s);return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{cursor:"pointer"},onClick:()=>O(n,s),title:"Click to copy location name",children:i}),r&&e.jsx("span",{style:{fontSize:"0.8em",color:"#6dd36d"},children:"Copied"})]})},sortingFn:(e,t)=>{const n=e=>{const t=u[Number(e)];if(!t)return"zzz";return`${null===t.security||void 0===t.security?999:d(t.security)}-${(t.name||"").toLowerCase()}`},i=n(e.original.location_id),s=n(t.original.location_id);return i.localeCompare(s)},size:470},{accessorKey:"location_id",id:"region_name",header:"Region",cell:e=>{const t=u[e.getValue()]?.regionName||"Unknown";return l(t)},sortingFn:(e,t)=>{const n=u[Number(e.original.location_id)]?.regionName||"",i=u[Number(t.original.location_id)]?.regionName||"";return n.localeCompare(i)},size:128},{accessorKey:"duration",header:"Expires in",cell:e=>{const{issued:t,duration:n}=e.row.original,i=new Date(t),s=new Date(i.getTime()+24*n*60*60*1e3),r=new Date,o=Math.max(Math.floor((s-r)/6e4),0);return a(o)},size:112}],[u,I]),W=t.useMemo(()=>[{accessorKey:"min_volume",header:"Min Volume",cell:e=>(e.getValue()??0).toLocaleString(),size:80},{accessorKey:"volume_remain",header:"Quantity",size:96},{accessorKey:"price",header:"Price",cell:e=>r(e.getValue()),size:160},{accessorFn:e=>{const t=u[Number(e.location_id)]?.security;return null==t?null:t},id:"security",header:"Sec.",cell:t=>{const n=t.row.original.location_id,i=u[n]?.security;return"number"==typeof i?e.jsx("span",{style:{color:o(i)},children:i.toFixed(1)}):e.jsx("span",{children:"—"})},size:78},{accessorFn:e=>{const t=u[Number(e.location_id)]?.isNPC;return t?"NPC":"Player"},id:"station_type",header:"Type",cell:t=>{const n=t.getValue();return e.jsx("span",{style:{color:"NPC"===n?"#4CAF50":"#2196F3",fontWeight:"500"},children:n})},size:65},{accessorKey:"location_id",id:"location_name",header:"Location",cell:t=>{const n=t.getValue(),i=l(u[n]?.name||"Unknown"),s=`${t.column.id}-${t.row.id}`,r=I.has(s);return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{cursor:"pointer"},onClick:()=>O(n,s),title:"Click to copy location name",children:i}),r&&e.jsx("span",{style:{fontSize:"0.8em",color:"#6dd36d"},children:"Copied"})]})},sortingFn:(e,t)=>{const n=e=>{const t=u[Number(e)];if(!t)return"zzz";return`${null===t.security||void 0===t.security?999:d(t.security)}-${(t.name||"").toLowerCase()}`},i=n(e.original.location_id),s=n(t.original.location_id);return i.localeCompare(s)},size:470},{accessorKey:"location_id",id:"region_name",header:"Region",cell:e=>{const t=u[e.getValue()]?.regionName||"Unknown";return l(t)},sortingFn:(e,t)=>{const n=u[Number(e.original.location_id)]?.regionName||"",i=u[Number(t.original.location_id)]?.regionName||"";return n.localeCompare(i)},size:128},{accessorKey:"range",header:"Range",cell:e=>c(e.getValue()),size:84},{accessorKey:"duration",header:"Expires in",cell:e=>{const{issued:t,duration:n}=e.row.original,i=new Date(t),s=new Date(i.getTime()+24*n*60*60*1e3),r=new Date,o=Math.max(Math.floor((s-r)/6e4),0);return a(o)},size:112}],[u,I]),K=(e,t,n,i,s)=>{const r=(e,t)=>{R(n=>({...n,[t]:"function"==typeof e?e(n[t]):e}))};return f({data:e,columns:t,defaultColumn:{minSize:60,maxSize:600,size:void 0,enableResizing:!0,enableColumnFilter:!0,filterFn:A},columnResizeMode:"onChange",getCoreRowModel:v(),getSortedRowModel:b(),getFilteredRowModel:x(),getExpandedRowModel:y(),state:{sorting:M[n],columnSizing:M[i],columnFilters:M[s]},enableSortingRemoval:!1,onSortingChange:e=>r(e,n),onColumnSizingChange:e=>r(e,i),onColumnFiltersChange:e=>r(e,s),getRowId:e=>e.order_id.toString()})},$=K(T,P,"sellerSorting","sellerSizing","sellerColumnFilters"),U=K(V,W,"buyerSorting","buyerSizing","buyerColumnFilters"),X=e=>{if(!e||0===e.length)return null;const t=e.reduce((e,t)=>e+(t.volume_remain??0),0),n=e.reduce((e,t)=>e+(t.price??0)*(t.volume_remain??0),0);return t>0?n/t:null},Q=t.useMemo(()=>X(T),[T]),G=t.useMemo(()=>X(V),[V]);de({count:$.getRowModel().rows.length,getScrollElement:()=>D.current,estimateSize:()=>24,overscan:5,initialOffset:0,getItemKey:e=>$.getRowModel().rows[e]?.id??e}),de({count:U.getRowModel().rows.length,getScrollElement:()=>_.current,estimateSize:()=>24,overscan:5,initialOffset:0,getItemKey:e=>U.getRowModel().rows[e]?.id??e});const J=(t,n)=>{const i="seller"===t?$:U;if(S[t]!==n)return null;const s="seller"===t?T:V;return e.jsxs("div",{className:"filter-panel-enhanced",ref:E,children:[e.jsx("div",{className:"filter-search-section",children:e.jsx("input",{type:"text",placeholder:"Search...",className:"filter-search-input",value:w[t]?.[n]||"",onChange:e=>{const i=e.target.value;k(e=>({...e,[t]:{...e[t],[n]:i}}))}})}),e.jsx("div",{className:"filter-options-list",children:(()=>{const i=F(s,n),r=N[t]?.[n],o=w[t]?.[n]||"",l=i.filter(e=>!o||e.toLowerCase().includes(o.toLowerCase()));return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"filter-select-all-option",children:[e.jsx("input",{type:"checkbox",checked:r?.selectAll||!1,onChange:e=>{const s=e.target.checked;C(e=>({...e,[t]:{...e[t],[n]:{selectAll:s,selectedValues:s?new Set(i):new Set}}}))}}),"(Select All)"]}),l.map(s=>{const o=r?.selectedValues?.has(s)||!1;return e.jsxs("label",{className:"filter-option",children:[e.jsx("input",{type:"checkbox",checked:o,onChange:e=>{const o=new Set(r?.selectedValues||[]);e.target.checked?o.add(s):o.delete(s);const l=o.size===i.length;C(e=>({...e,[t]:{...e[t],[n]:{selectAll:l,selectedValues:o}}}))}}),s]},s)})]})})()}),e.jsxs("div",{className:"filter-actions",children:[e.jsxs("button",{className:"filter-cancel-btn",onClick:()=>L(t),children:[e.jsx(H,{})," Cancel"]}),e.jsxs("button",{className:"filter-ok-btn",onClick:()=>((e,t,n)=>{const i=N[e]?.[t];if(!i)return;const s=F("seller"===e?T:V,t),r=Array.from(i.selectedValues),o=r.length===s.length?[]:r;n.getColumn(t).setFilterValue(o),j(t=>({...t,[e]:null})),C(n=>({...n,[e]:{...n[e],[t]:void 0}}))})(t,n,i),children:[e.jsx(q,{})," OK"]})]})]})},Y=(t,n,i)=>({column:s})=>{const r=["security","station_type","region_name","location_name","range"].includes(s.id),o=S[n]===s.id;return e.jsxs("div",{className:"header-with-filter",children:[e.jsxs("span",{className:"header-text",onClick:()=>{const e=s.getIsSorted();e?"asc"===e?s.toggleSorting(!0):s.clearSorting():s.toggleSorting(!1)},style:{cursor:"pointer"},children:[t,"asc"===s.getIsSorted()?" ▲":"desc"===s.getIsSorted()?" ▼":""]}),r&&e.jsx("button",{className:"filter-button",onClick:e=>{e.stopPropagation(),o?L(n):((e,t,n)=>{const i=n.getColumn(t).getFilterValue()||[],s=F("seller"===e?T:V,t),r=0===i.length;C(n=>({...n,[e]:{...n[e],[t]:{selectAll:r,selectedValues:r?new Set(s):new Set(i)}}})),j(n=>({...n,[e]:t}))})(n,s.id,i)},title:"Filter column",children:e.jsx(B,{})})]})},Z=(t,n,i,s,r)=>e.jsxs("div",{className:"market-table-wrapper",children:[e.jsxs("h3",{className:"market-table-title",children:[t," (",n.getRowModel().rows.length," orders)","seller"===r&&null!==Q&&e.jsxs("span",{style:{marginLeft:"1rem",fontWeight:"normal",fontSize:"0.95em",color:"#ccc"},children:["Avg Price: ",Q.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ISK"]}),"buyer"===r&&null!==G&&e.jsxs("span",{style:{marginLeft:"1rem",fontWeight:"normal",fontSize:"0.95em",color:"#ccc"},children:["Avg Price: ",G.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ISK"]})]}),e.jsxs("div",{className:"market-table",children:[e.jsx("div",{className:"thead",children:n.getHeaderGroups().map(t=>e.jsx("div",{className:"thead-row",children:t.headers.map(t=>e.jsxs("div",{className:"column-header-wrapper",children:[e.jsxs("div",{className:"column-header",style:{width:t.getSize()},children:[t.column.columnDef.Header?p(t.column.columnDef.Header,t.getContext()):Y(t.column.columnDef.header,r,n)(t.getContext()),t.column.getCanResize()&&e.jsx("div",{onMouseDown:t.getResizeHandler(),onTouchStart:t.getResizeHandler(),className:"resizer "+(t.column.getIsResizing()?"isResizing":"")})]}),J(r,t.column.id)]},t.id))},t.id))}),e.jsx("div",{ref:i,className:"table-body",children:e.jsx("div",{style:{height:s.getTotalSize(),position:"relative"},children:s.getVirtualItems().map(t=>{const i=n.getRowModel().rows[t.index];return e.jsx("div",{className:"table-row",style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${t.start}px)`},children:i.getVisibleCells().map(t=>e.jsx("div",{className:"table-cell",style:{width:t.column.getSize(),whiteSpace:"nowrap"},children:p(t.column.columnDef.cell,t.getContext())},t.id))},i.id)})})})]})]}),ee=t.useMemo(()=>P.map(e=>({...e,Header:(["security","region_name","location_name","range"].includes(e.id),Y(e.header,"seller",$))})),[P,$]),te=t.useMemo(()=>W.map(e=>({...e,Header:(["security","region_name","location_name","range"].includes(e.id),Y(e.header,"buyer",U))})),[W,U,V]),ne=f({data:T,columns:ee,defaultColumn:{minSize:60,maxSize:600,size:void 0,enableResizing:!0,enableColumnFilter:!0,filterFn:A},columnResizeMode:"onChange",getCoreRowModel:v(),getSortedRowModel:b(),getFilteredRowModel:x(),getExpandedRowModel:y(),state:{sorting:M.sellerSorting,columnSizing:M.sellerSizing,columnFilters:M.sellerColumnFilters},enableSortingRemoval:!1,onSortingChange:e=>R(t=>({...t,sellerSorting:"function"==typeof e?e(t.sellerSorting):e})),onColumnSizingChange:e=>R(t=>({...t,sellerSizing:"function"==typeof e?e(t.sellerSizing):e})),onColumnFiltersChange:e=>R(t=>({...t,sellerColumnFilters:"function"==typeof e?e(t.sellerColumnFilters):e})),getRowId:e=>e.order_id.toString()}),ie=f({data:V,columns:te,defaultColumn:{minSize:60,maxSize:600,size:void 0,enableResizing:!0,enableColumnFilter:!0,filterFn:A},columnResizeMode:"onChange",getCoreRowModel:v(),getSortedRowModel:b(),getFilteredRowModel:x(),getExpandedRowModel:y(),state:{sorting:M.buyerSorting,columnSizing:M.buyerSizing,columnFilters:M.buyerColumnFilters},enableSortingRemoval:!1,onSortingChange:e=>R(t=>({...t,buyerSorting:"function"==typeof e?e(t.buyerSorting):e})),onColumnSizingChange:e=>R(t=>({...t,buyerSizing:"function"==typeof e?e(t.buyerSizing):e})),onColumnFiltersChange:e=>R(t=>({...t,buyerColumnFilters:"function"==typeof e?e(t.buyerColumnFilters):e})),getRowId:e=>e.order_id.toString()}),se=de({count:ne.getRowModel().rows.length,getScrollElement:()=>D.current,estimateSize:()=>24,overscan:5,initialOffset:0,getItemKey:e=>ne.getRowModel().rows[e]?.id??e}),re=de({count:ie.getRowModel().rows.length,getScrollElement:()=>_.current,estimateSize:()=>24,overscan:5,initialOffset:0,getItemKey:e=>ie.getRowModel().rows[e]?.id??e});return e.jsxs(e.Fragment,{children:[Z("Sellers",ne,D,se,"seller"),Z("Buyers",ie,_,re,"buyer")]})}function he({orders:n=[],regions:i=[],onRegionClick:s,selectedRegion:r}){if("all"!==r?.regionID)return e.jsxs("div",{style:{width:"100%",height:400,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",background:"#1a1a1a",color:"#fff",border:"1px solid #333"},children:[e.jsx("p",{children:'Market distribution chart is only available when "All Regions" is selected.'}),e.jsxs("p",{style:{marginTop:"10px",fontSize:"0.9em",opacity:.7},children:["Current selection: ",r?.regionName||"None"]}),e.jsx("p",{style:{marginTop:"10px",fontSize:"0.9em",opacity:.7},children:'Select "All Regions" from the region dropdown to view market distribution across regions.'})]});const o=t.useMemo(()=>{if(!n||0===n.length)return[];const e=n.map(e=>e.price).filter(e=>e>0&&!isNaN(e));if(0===e.length)return[];e.sort((e,t)=>e-t);const t=Math.floor(.01*e.length),i=Math.floor(.99*e.length),s=Math.max(0,t),r=Math.min(e.length-1,i),o=e[s],l=e[r];return n.filter(e=>{const t=e.price,n=e.volume_remain,i=t>=o&&t<=l,s=n>0,r=e.regionName&&"Unknown"!==e.regionName;return i&&s&&r})},[n]),l=t.useMemo(()=>{if(!i||0===i.length)return[];const e={};i.forEach(t=>{const n=t.regionName||t.name;n&&(e[n]={region:n,buyerVolume:0,sellerVolume:0,buyerCount:0,sellerCount:0})}),o.forEach(t=>{const n=t.regionName;e[n]||(e[n]={region:n,buyerVolume:0,sellerVolume:0,buyerCount:0,sellerCount:0});const i=e[n];t.is_buy_order?(i.buyerVolume+=t.volume_remain||0,i.buyerCount+=1):(i.sellerVolume+=t.volume_remain||0,i.sellerCount+=1)});return Object.values(e).sort((e,t)=>e.region.localeCompare(t.region))},[o,i]);t.useEffect(()=>{l.length,n.length>0&&o.length,o.length>0&&l.length},[l,n,o,i]);const a=({active:t,payload:n,label:i})=>t&&n&&n.length?e.jsxs("div",{style:{backgroundColor:"#2a2a2a",border:"1px solid #444",borderRadius:"4px",padding:"10px",color:"#fff"},children:[e.jsx("p",{style:{margin:"0 0 5px 0",fontWeight:"bold"},children:i}),n.map((t,n)=>e.jsxs("p",{style:{margin:"2px 0",color:t.color,fontSize:"12px"},children:[t.name,": ",t.value?.toLocaleString()||0]},n))]}):null;return l&&0!==l.length?e.jsxs("div",{style:{width:"100%",height:400,background:"#1a1a1a",border:"1px solid #333",padding:"10px"},children:[e.jsxs("div",{style:{color:"#fff",marginBottom:"10px",fontSize:"12px"},children:["Showing data for ",l.length," regions with market activity"]}),e.jsx(S,{width:"100%",height:"90%",children:e.jsxs(j,{data:l,margin:{top:20,right:50,left:50,bottom:80},children:[e.jsx(w,{dataKey:"region",angle:-45,textAnchor:"end",interval:0,height:100,fontSize:10,stroke:"#ccc"}),e.jsx(k,{yAxisId:"left",orientation:"left",stroke:"#2ca02c",fontSize:10,label:{value:"Seller Volume (Supply)",angle:-90,position:"insideLeft",style:{textAnchor:"middle"}}}),e.jsx(k,{yAxisId:"right",orientation:"right",stroke:"#ff7f0e",fontSize:10,label:{value:"Buyer Volume (Demand)",angle:90,position:"insideRight",style:{textAnchor:"middle"}}}),e.jsx(N,{content:e.jsx(a,{})}),e.jsx(C,{payload:[{value:"Seller Volume (Supply)",type:"rect",color:"#2ca02c",id:"sellerVolume"},{value:"Buyer Volume (Demand)",type:"line",color:"#ff7f0e",id:"buyerVolume"}],verticalAlign:"top",height:36,wrapperStyle:{color:"#fff",fontSize:"12px"}}),e.jsx(I,{yAxisId:"left",dataKey:"sellerVolume",fill:"#2ca02c",name:"Seller Volume (Supply)",onClick:e=>{s&&e?.region&&s(e.region)},cursor:"pointer"}),e.jsx(z,{yAxisId:"right",type:"monotone",dataKey:"buyerVolume",stroke:"#ff7f0e",strokeWidth:2,name:"Buyer Volume (Demand)",dot:{r:3,fill:"#ff7f0e"},activeDot:{r:5,fill:"#ff7f0e"}})]})})]}):e.jsxs("div",{style:{width:"100%",height:400,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",background:"#1a1a1a",color:"#fff",border:"1px solid #333"},children:[e.jsx("h3",{children:"No Market Data Available"}),e.jsxs("div",{style:{textAlign:"left",fontSize:"12px",opacity:.7,marginTop:"20px"},children:[e.jsx("p",{children:"Debug Info:"}),e.jsxs("p",{children:["• Raw orders: ",n?.length||0]}),e.jsxs("p",{children:["• Filtered orders: ",o.length]}),e.jsxs("p",{children:["• Regions: ",i?.length||0]}),e.jsxs("p",{children:["• Chart data points: ",l.length]}),o.length>0&&e.jsxs("p",{children:["• Sample order region: ",o[0]?.regionName||"Unknown"]})]})]})}function me({selectedItem:n,selectedRegion:i,setActiveTab:s}){const[r,o]=t.useState([]),[l,a]=t.useState(0),[c,d]=t.useState(30),[u,h]=t.useState(!1),[m,g]=t.useState(null),f=t.useRef(null),p=t.useRef(null),y=t.useRef({type:null,startX:0,initialStartIndex:0,initialEndIndex:0});function x(e,t){e.preventDefault(),e.stopPropagation(),y.current={type:t,startX:e.clientX,initialStartIndex:l,initialEndIndex:c},document.body.style.cursor="move"===t?"grabbing":"ew-resize",window.addEventListener("mousemove",b),window.addEventListener("mouseup",v)}function b(e){if(!y.current.type||!f.current||0===r.length)return;const t=e.clientX-y.current.startX,n=f.current.offsetWidth,i=Math.round(t/n*r.length);let s=y.current.initialStartIndex,o=y.current.initialEndIndex;if("move"===y.current.type){const e=o-s;s=Math.max(0,Math.min(r.length-e,s+i)),o=s+e}else"resize-left"===y.current.type?(s=Math.max(0,Math.min(o-1,s+i)),o-s>365&&(s=o-365)):"resize-right"===y.current.type&&(o=Math.min(r.length,Math.max(s+1,o+i)),o-s>365&&(o=s+365));a(s),d(o)}function v(){document.body.style.cursor="",window.removeEventListener("mousemove",b),window.removeEventListener("mouseup",v),y.current={type:null,startX:0,initialStartIndex:0,initialEndIndex:0}}if(t.useEffect(()=>{if(!n)return o([]),void g("No item selected");let e=!1;return h(!0),g(null),async function(){try{let t;if(t=!i||"all"===i.regionID?await R(n.typeID):await D(n.typeID,i.regionID),e)return;o(t||[]);const s=0,r=t?.length||0;a(s),d(r)}catch(t){if(e)return;g(t.message||"Failed to load market history")}finally{e||h(!1)}}(),()=>{e=!0}},[n,i]),u)return e.jsx("div",{style:{width:"100%",height:500,display:"flex",alignItems:"center",justifyContent:"center",background:"#1a1a1a",color:"#fff",border:"1px solid #333"},children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{children:"Loading universe market history..."}),e.jsxs("div",{style:{fontSize:"12px",opacity:.7,marginTop:"10px"},children:["Item: ",n?.typeName||"Unknown"]})]})});if(m)return e.jsx("div",{style:{width:"100%",height:500,display:"flex",alignItems:"center",justifyContent:"center",background:"#1a1a1a",color:"#fff",border:"1px solid #333"},children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{color:"#ff6b6b"},children:"Error loading universe market history"}),e.jsx("div",{style:{fontSize:"12px",opacity:.7,marginTop:"10px"},children:m}),e.jsxs("div",{style:{fontSize:"12px",opacity:.5,marginTop:"10px"},children:["Debug: Item=",n?.typeName]})]})});if(!r.length)return e.jsx("div",{style:{width:"100%",height:500,display:"flex",alignItems:"center",justifyContent:"center",background:"#1a1a1a",color:"#fff",border:"1px solid #333"},children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{children:"No market history available"}),e.jsx("div",{style:{fontSize:"12px",opacity:.7,marginTop:"10px"},children:"This could be due to:"}),e.jsxs("ul",{style:{fontSize:"12px",opacity:.7,textAlign:"left",marginTop:"5px"},children:[e.jsx("li",{children:"Item not actively traded"}),e.jsx("li",{children:"API service unavailable"}),e.jsx("li",{children:"Network connectivity issues"}),e.jsx("li",{children:"Invalid item data"})]}),e.jsxs("div",{style:{fontSize:"12px",opacity:.5,marginTop:"10px"},children:["Debug: Item=",n?.typeName]})]})});const _=Math.max(0,Math.min(l,r.length-1)),A=Math.max(_+1,Math.min(c,r.length)),O=r.slice(_,A),F=!i||"all"===i.regionID?"All Regions (Universe)":i.regionName,L=({active:t,payload:n,label:i})=>t&&n&&n.length?e.jsxs("div",{style:{backgroundColor:"#2a2a2a",border:"1px solid #444",borderRadius:"4px",padding:"10px",color:"#fff"},children:[e.jsx("p",{style:{margin:"0 0 5px 0",fontWeight:"bold"},children:i}),n.map((t,n)=>e.jsxs("p",{style:{margin:"2px 0",color:t.color,fontSize:"12px"},children:[t.name,": ",t.value?.toLocaleString()||"N/A"]},n))]}):null;return e.jsxs("div",{style:{width:"100%",height:500,background:"#1a1a1a",border:"1px solid #333",padding:"10px"},children:[e.jsxs("div",{style:{color:"#fff",marginBottom:"10px",fontSize:"12px"},children:["Market History: ",n?.typeName," - ",F," | Showing ",O.length," of ",r.length," days | Range: ",_,"-",A,r.length<7&&r.length>0&&e.jsxs("span",{style:{color:"#ffa500",marginLeft:"10px"},children:["⚠️ Limited market data available (",r.length," day",1===r.length?"":"s",")"]}),0===r.length&&e.jsx("span",{style:{color:"#ff6b6b",marginLeft:"10px"},children:"❌ No market history data available"})]}),e.jsx(S,{width:"100%",height:380,children:e.jsxs(j,{data:O,margin:{top:20,right:50,left:50,bottom:50},children:[e.jsx(E,{strokeDasharray:"3 3",stroke:"#444"}),e.jsx(w,{dataKey:"date",angle:-45,textAnchor:"end",interval:Math.max(0,Math.floor(O.length/10)),stroke:"#ccc",fontSize:10}),e.jsx(k,{yAxisId:"left",label:{value:"Avg Price (ISK)",angle:-90,position:"insideLeft",style:{textAnchor:"middle"}},tickFormatter:e=>e?e.toLocaleString():"",domain:["auto","auto"],stroke:"#1f77b4",fontSize:10}),e.jsx(k,{yAxisId:"right",orientation:"right",label:{value:"Volume",angle:90,position:"insideRight",style:{textAnchor:"middle"}},tickFormatter:e=>e?e.toLocaleString():"",domain:[0,"auto"],stroke:"#8884d8",fontSize:10}),e.jsx(N,{content:e.jsx(L,{})}),e.jsx(C,{verticalAlign:"top",height:36,wrapperStyle:{color:"#fff",fontSize:"12px"}}),e.jsx(z,{yAxisId:"left",type:"monotone",dataKey:"average",stroke:"#1f77b4",strokeWidth:2,dot:!1,name:"Average Price"}),e.jsx(I,{yAxisId:"right",dataKey:"totalVolume",fill:"#8884d8",barSize:Math.max(1,Math.min(20,300/O.length)),opacity:.4,name:"Volume"})]})}),e.jsxs("div",{ref:f,style:{position:"relative",height:60,marginTop:10,background:"#555",border:"1px solid #666",overflow:"hidden",userSelect:"none"},children:[e.jsx("div",{style:{position:"absolute",inset:0,zIndex:1},children:e.jsx(S,{width:"100%",height:"100%",children:e.jsx(j,{data:r,children:e.jsx(M,{type:"monotone",dataKey:"totalVolume",stroke:"#8884d8",fill:"#8884d8",opacity:.3})})})}),e.jsxs("div",{ref:p,style:{position:"absolute",top:0,left:_/r.length*100+"%",width:(A-_)/r.length*100+"%",height:"100%",background:"rgba(100, 149, 237, 0.3)",border:"2px solid #6495ED",borderRadius:4,boxShadow:"0 0 4px rgba(0,0,0,0.2)",display:"flex",justifyContent:"space-between",alignItems:"center",cursor:"move"===y.current.type?"grabbing":"grab",zIndex:2,transition:y.current.type?"none":"all 0.1s ease"},onMouseDown:e=>x(e,"move"),children:[e.jsx("div",{style:{width:8,height:"100%",cursor:"ew-resize",background:"#6495ED",borderRadius:"4px 0 0 4px",transition:"background-color 0.2s ease"},onMouseDown:e=>x(e,"resize-left"),onMouseEnter:e=>e.target.style.backgroundColor="#4169E1",onMouseLeave:e=>e.target.style.backgroundColor="#6495ED"}),e.jsxs("div",{style:{position:"absolute",top:4,right:8,background:"rgba(0,0,0,0.8)",color:"#fff",padding:"2px 6px",borderRadius:4,fontSize:12,pointerEvents:"none"},children:[A-_,"d"]}),e.jsx("div",{style:{width:8,height:"100%",cursor:"ew-resize",background:"#6495ED",borderRadius:"0 4px 4px 0",transition:"background-color 0.2s ease"},onMouseDown:e=>x(e,"resize-right"),onMouseEnter:e=>e.target.style.backgroundColor="#4169E1",onMouseLeave:e=>e.target.style.backgroundColor="#6495ED"})]})]})]})}function ge({regionsData:n,filterOutliers:i}){const s=t.useRef(null),[r,o]=t.useState(null);return t.useEffect(()=>{n&&async function(e,t=!0){try{const e=44992,i=19000001;let s=[];try{const t=await _(e,i);s=[...t.sellOrders||[],...t.buyOrders||[]]}catch(n){return{name:"PLEX",highestBuy:null,lowestSell:null,averageSell:null}}const r=s.filter(e=>!e.is_buy_order),o=s.filter(e=>e.is_buy_order),l=u(r,t),a=u(o,t),c=(e=>{if(!e||0===e.length)return null;const t=e.reduce((e,t)=>e+t.volume_remain,0),n=e.reduce((e,t)=>e+t.price*t.volume_remain,0);return t>0?n/t:null})(l);return{name:"PLEX",highestBuy:a.length>0?Math.max(...a.map(e=>e.price)):null,lowestSell:l.length>0?Math.min(...l.map(e=>e.price)):null,averageSell:c}}catch(n){throw n}}(0,i).then(e=>{o(e)}).catch(e=>{})},[n,i]),t.useEffect(()=>{if(!r||!s.current)return;const e=s.current;e.innerHTML="";const t=document.createElement("div");t.className="marquee__item";const n=[{label:"Highest Buy",value:r.highestBuy,className:"highest"},{label:"Lowest Sell",value:r.lowestSell,className:"lowest"},{label:"Average Sell",value:r.averageSell,className:"average"}].filter(e=>null!==e.value);if(n.forEach(({label:e,value:n,className:i})=>{const s=document.createElement("span");s.className=`marquee__text ${i}`,s.textContent=`PLEX — ${e}: ${(e=>`${e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})} ISK`)(n)} • `,t.appendChild(s)}),0===n.length){const e=document.createElement("span");e.className="marquee__text",e.textContent="PLEX — Loading market data... • ",t.appendChild(e)}e.appendChild(t),e.offsetWidth;const i=t.offsetWidth,o=e.parentElement.offsetWidth,l=Math.ceil(o/i*2)+2;for(let s=1;s<l;s++)e.appendChild(t.cloneNode(!0));const a=`marquee-scroll-${Date.now()}`,c=`\n            @keyframes ${a} {\n                0% { transform: translateX(0); }\n                100% { transform: translateX(-${i}px); }\n            }\n        `,d=document.createElement("style");return d.id="marquee-keyframes",d.textContent=c,document.head.appendChild(d),e.style.animation=`${a} ${i/60}s linear infinite`,()=>{document.querySelector("#marquee-keyframes")?.remove()}},[r]),e.jsx("div",{id:"plexTicker",className:"marquee",children:e.jsx("div",{ref:s,className:"marquee__content"})})}function fe(){const[n,s]=t.useState(null),[r,o]=t.useState(null),[l,a]=t.useState({regionID:"all",regionName:"All Regions"}),[c,d]=t.useState("orders"),[g,f]=t.useState(null),[p,y]=t.useState([]),[x,b]=t.useState([]),[v,S]=t.useState("none"),[j,w]=t.useState([]),[k,N]=t.useState([]),[C,I]=t.useState({}),z=i(),E=new URLSearchParams(z.search),M=parseInt(E.get("item")||"0",10),[R,D]=t.useState(null);t.useEffect(()=>{try{let e=h;e&&!Array.isArray(e)&&"object"==typeof e&&(e=Object.entries(e).map(([e,t])=>({...t,name:e}))),Array.isArray(e)&&0!==e.length?(D(null),s(e)):(D("Market tree data is empty or invalid."),s(null))}catch(e){D("Failed to load market tree."),s(null)}},[]);const O=t.useMemo(()=>n?m(n):{items:[],pathMap:{}},[n]);t.useEffect(()=>{(async function(){const e=await fetch("/EVE-Data-Site/data/regions.json");if(!e.ok)throw new Error("Failed to load regions.json");const t=await e.json();return Array.isArray(t)?t:t.regions||[]})().then(w).catch(e=>{})},[]),t.useEffect(()=>{if(!j.length)return;const e=new Map;j.forEach(t=>e.set(Number(t.regionID),t.regionName));const t={};A.forEach(n=>{const i=Number(n.station_id||n.stationID);t[i]={name:n.name,security:"number"==typeof n.security_status?n.security_status:"number"==typeof n.security?n.security:null,regionName:n.region_name||e.get(Number(n.region_id||n.regionID))||"Unknown",type:"station",isNPC:!0}}),k.forEach(n=>{const i=Number(n.stationID);t[i]={name:n.locationName,security:"number"==typeof n.security?n.security:null,regionName:n.regionName||e.get(Number(n.regionID))||"Unknown",type:"structure",isNPC:"npc"===n.type}}),I(t)},[j,k]),t.useEffect(()=>{fetch("/EVE-Data-Site/data/structures.json").then(e=>{if(!e.ok)throw new Error("Failed to load structures.json");return e.json()}).then(N).catch(e=>{})},[]),t.useEffect(()=>{if(O?.items?.length&&M){const e=O.items.find(e=>e.typeID===M);if(e){o(e),f(O.pathMap[M]),d("orders");const t=new URL(window.location.href);t.search="",window.history.replaceState({},"",t.toString())}}},[O,M]);const F=t.useCallback(async()=>{if(r&&j.length)try{let e=[];const t=l?.regionID,n=44992,i=19000001;if(r.typeID===n){const t=await _(r.typeID,i);e=[...t.sellOrders||[],...t.buyOrders||[]].map(e=>({...e,region_id:i}))}else if(t&&"all"!==t){const n=await _(r.typeID,t);e=[...n.sellOrders||[],...n.buyOrders||[]].map(e=>({...e,region_id:e.region_id||t}))}else{const t=j.map(async e=>{try{const t=await _(r.typeID,e.regionID);return[...t.sellOrders||[],...t.buyOrders||[]].map(t=>({...t,region_id:e.regionID}))}catch{return[]}});e=(await Promise.all(t)).flat()}const s=u(e.filter(e=>!e.is_buy_order),v),o=u(e.filter(e=>e.is_buy_order),v);y(s),b(o)}catch(e){}},[r,l,j,v]);t.useEffect(()=>{F()},[F]),t.useEffect(()=>{const e=[...p,...x];if(0===e.length)return;const t={...C};let n=0;e.forEach(e=>{const i=Number(e.location_id);!t[i]&&i>0&&(t[i]={name:e.name||e.location_name||"Unknown Location",regionName:e.region_name||e.regionName||"Unknown Region",security:"number"==typeof e.security?e.security:"number"==typeof e.security_status?e.security_status:null,type:e.location_type||e.type||"unknown",isNPC:1===e.is_npc||!0===e.isNPC},n++)}),n>0&&I(t)},[p,x]);const L=t.useMemo(()=>{const e=[...p,...x],t=new Map(j.map(e=>[Number(e.regionID),e.regionName]));return e.map(e=>({...e,regionName:t.get(Number(e.region_id))||`Region ${e.region_id||"Unknown"}`}))},[p,x,j]);t.useEffect(()=>{const e=()=>{const e=new URLSearchParams(window.location.search).get("item");if(e&&n){const t=((e,t)=>{const n=Number(e),i=e=>{if(!e||"object"!=typeof e)return null;if(Array.isArray(e.items)){const t=e.items.find(e=>Number(e.typeID)===n);if(t)return t}for(const[t,n]of Object.entries(e))if("_info"!==t&&"items"!==t&&n&&"object"==typeof n&&!Array.isArray(n)){const e=i(n);if(e)return e}return null};if(Array.isArray(t))for(const s of t){const e=i(s);if(e)return e}else for(const[,s]of Object.entries(t))if(s&&"object"==typeof s){const e=i(s);if(e)return e}return null})(e,n);t&&o(t)}};return window.addEventListener("popstate",e),()=>window.removeEventListener("popstate",e)},[n]);return e.jsxs("div",{className:"market",children:[R&&e.jsx("div",{style:{color:"red",padding:"1rem"},children:R}),e.jsxs("div",{className:"market-body",children:[e.jsx("div",{className:"left-panel",children:e.jsx($,{selectedRegion:l,onRegionChange:a,regions:j,onItemSelect:e=>{if(o(e),window.location.search){const e=new URL(window.location.href);e.search="",window.history.replaceState({},"",e.toString())}d("orders")},marketTree:n,breadcrumbPath:g})}),e.jsx("div",{className:"right-panel",children:r&&!R&&e.jsxs(e.Fragment,{children:[e.jsx(X,{selectedItem:r,marketTree:n,onBreadcrumbClick:e=>{f(e),setTimeout(()=>{const t=e.join("/"),n=document.querySelector(`[data-path="${t}"]`);n&&n.scrollIntoView({behavior:"smooth",block:"center"})},100)}}),e.jsxs("div",{className:"market-tabs-container",style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{className:"market-tabs",children:[e.jsx("button",{className:"orders"===c?"active":"",onClick:()=>d("orders"),children:"Market Orders"}),e.jsx("button",{className:"history"===c?"active":"",onClick:()=>d("history"),children:"Market History"}),e.jsx("button",{className:"distribution"===c?"active":"",onClick:()=>d("distribution"),children:"Market Distribution"}),e.jsxs("div",{style:{marginLeft:"1rem",display:"inline-flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{children:"Outlier Filter: "}),e.jsxs("select",{value:v,onChange:e=>S(e.target.value),style:{padding:"2px 4px",background:"#2a2a2a",color:"#eee",border:"1px solid #444",borderRadius:"4px"},children:[e.jsx("option",{value:"none",children:"No outlier prices filtered out"}),e.jsx("option",{value:"mild",children:"5th to 95th percentile (1.5 IQR)"}),e.jsx("option",{value:"moderate",children:"10th to 90th percentile (1.0 IQR)"}),e.jsx("option",{value:"strict",children:"25th to 75th percentile (0.5 IQR)"}),e.jsx("option",{value:"ultra",children:"37.5th to 62.5th percentile (0.25 IQR)"})]})]})]}),e.jsx("div",{className:"market-tabs-right",style:{display:"flex",alignItems:"center",gap:"1rem"}})]}),"orders"===c&&Object.keys(C).length>0&&e.jsx(ue,{sellers:p,buyers:x,selectedRegion:l,locationInfoMap:C,activeTab:c,setActiveTab:d,itemName:r?.typeName}),"history"===c&&e.jsx(me,{selectedItem:r,selectedRegion:l}),"distribution"===c&&e.jsx(he,{orders:L,regions:j,selectedRegion:l,onRegionClick:e=>{const t=j?.find(t=>t.regionName===e);t&&(a({regionID:t.regionID,regionName:t.regionName}),d("orders"))}})]})})]}),e.jsx(ge,{regionsData:j,filterOutliers:v})]})}export{fe as default};
